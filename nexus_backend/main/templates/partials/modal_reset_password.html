{% load i18n static %}
<div id="resetPasswordModal" class="hidden fixed inset-0 z-[120]">
  <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/70 to-gray-950 backdrop-blur-sm"></div>
  <div class="relative min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white/95 border border-gray-200 rounded-2xl shadow-2xl animate__animated animate__fadeInUp">
      <div class="flex items-center justify-between px-6 pt-6">
        <h3 class="text-lg font-bold text-gray-800">{% trans "Reset password" %}</h3>
        <button type="button" class="p-2 rounded hover:bg-gray-100" onclick="closeResetPasswordModal()" aria-label="{% trans 'Close' %}">
          <i class="fa-solid fa-xmark text-gray-600"></i>
        </button>
      </div>
      <div class="px-6 pb-6 pt-4">
        <div id="reset-password-alert" class="hidden mb-4 px-4 py-2 rounded text-sm"></div>
        <form id="resetPasswordForm" method="post" action="{% url 'password_reset_request' %}" class="space-y-4">
          {% csrf_token %}
          <div>
            <label for="reset_email" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Adresse email enregistrée" %}</label>
            <input id="reset_email" name="email" type="email" required class="w-full px-4 py-3 rounded-lg bg-white border border-gray-300 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <button id="resetPasswordSubmit" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2">
            <svg id="resetSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <span id="resetSubmitLabel" class="inline-block">{% trans "Envoyer le lien de réinitialisation" %}</span>
          </button>
        </form>
        <p class="mt-5 text-xs text-gray-500 leading-relaxed">{% trans "Entrez votre adresse email enregistrée. Un lien de réinitialisation vous sera envoyé si le compte existe." %}</p>
      </div>
    </div>
  </div>
</div>
<script>
function openResetPasswordModal() {
  document.getElementById('resetPasswordModal').classList.remove('hidden');
}
function closeResetPasswordModal() {
  document.getElementById('resetPasswordModal').classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('resetPasswordForm');
  const alertBox = document.getElementById('reset-password-alert');
  if (form) {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      alertBox.classList.add('hidden');
      const submitBtn = document.getElementById('resetPasswordSubmit');
      const spinner = document.getElementById('resetSpinner');
      const label = document.getElementById('resetSubmitLabel');
      // disable and show spinner
      if (submitBtn) submitBtn.disabled = true;
      if (spinner) spinner.classList.remove('hidden');
      if (label) label.classList.add('opacity-50');
      const fd = new FormData(form);
      try {
        const res = await fetch(form.action, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          },
          body: fd
        });
        const data = await res.json();
        alertBox.textContent = data.message || 'Request completed.';
        alertBox.className = 'mb-4 px-4 py-2 rounded text-sm ' + (data.success ? 'bg-green-50 text-green-700' : 'bg-red-100 text-red-700');
        alertBox.classList.remove('hidden');
        if (data.success) {
          form.reset();
        }
        // re-enable and hide spinner
        if (submitBtn) submitBtn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (label) label.classList.remove('opacity-50');
      } catch (err) {
        alertBox.textContent = 'Server error. Please try again.';
        alertBox.className = 'mb-4 px-4 py-2 rounded text-sm bg-red-100 text-red-700';
        alertBox.classList.remove('hidden');
        // re-enable and hide spinner on error
        if (submitBtn) submitBtn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (label) label.classList.remove('opacity-50');
      }
    });
  }
});
</script>
