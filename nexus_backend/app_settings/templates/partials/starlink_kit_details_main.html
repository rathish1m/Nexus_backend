{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}

{% include 'partials/edit_kit_modal.html' %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% include 'partials/kit_modal.html' %}

<section class="bg-white rounded-lg shadow border p-4 sm:p-6 w-full">
  <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
    <h2 class="text-lg font-semibold text-gray-800">{% trans "Starlink Kits" %}</h2>
    <button onclick="openModal('hardware')" class="w-full sm:w-auto bg-blue-600 text-white px-5 py-2 rounded-md text-sm hover:bg-blue-700 transition">
      {% trans "Add Kit" %}
    </button>
  </div>

  {# Mobile Cards (shown < md) #}
  <div id="kit_cards" class="md:hidden grid grid-cols-1 gap-3"></div>

  {# Desktop Table (shown ‚â• md) #}
  <div class="overflow-x-auto hidden md:block">
    <table class="w-full text-sm text-left">
      <thead class="text-xs bg-gray-50 text-gray-600 uppercase">
        <tr>
          <th class="py-2 px-3">{% trans "Name" %}</th>
          <th class="py-2 px-3">{% trans "Model" %}</th>
          <th class="py-2 px-3">{% trans "Description" %}</th>
          <th class="py-2 px-3">{% trans "Price (USD)" %}</th>
          <th class="py-2 px-3">{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody id="kit_table_body" class="text-gray-700 divide-y">
        <!-- Populated dynamically -->
      </tbody>
    </table>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", fetchKits);

  function fetchKits() {
    fetch("{% url 'get_kits' %}", { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(response => {
        if (!response.ok) throw new Error("Network error");
        return response.json();
      })
      .then(data => {
        const tbody = document.getElementById("kit_table_body");
        const cards = document.getElementById("kit_cards");
        tbody.innerHTML = "";
        cards.innerHTML = "";

        if (!data.kit || data.kit.length === 0) {
          // Desktop placeholder
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-gray-500 py-4">üì≠ {% trans "No kits available." %}</td>
            </tr>`;
          // Mobile placeholder
          cards.innerHTML = `
            <div class="text-center text-gray-500 py-6 border rounded-lg">üì≠ {% trans "No kits available." %}</div>`;
          return;
        }

        data.kit.forEach(kit => {
          // ---- Desktop row ----
          const row = `
            <tr class="hover:bg-gray-50">
              <td class="py-2 px-3 font-medium">${escapeHTML(kit.name)}</td>
              <td class="py-2 px-3">${escapeHTML(kit.model || '')}</td>
              <td class="py-2 px-3">${escapeHTML(truncateWords(kit.description, 10))}</td>
              <td class="py-2 px-3">${kit.price_usd ?? '‚Äî'}</td>
              <td class="py-2 px-3">
                <div class="flex flex-wrap gap-2">
                  <button onclick="handleEditKit(${kit.id})"
                          class="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded hover:bg-yellow-200 transition">
                    <i class="fas fa-edit mr-1"></i> {% trans "Edit" %}
                  </button>
                  <button onclick="deleteKit(${kit.id})"
                          class="inline-flex items-center px-3 py-1 bg-red-100 text-red-700 text-xs font-medium rounded hover:bg-red-200 transition">
                    <i class="fas fa-trash-alt mr-1"></i> {% trans "Delete" %}
                  </button>
                </div>
              </td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", row);

          // ---- Mobile card ----
          const card = `
            <div class="border rounded-lg p-4 shadow-sm bg-white">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h3 class="text-base font-semibold text-gray-900">${escapeHTML(kit.name)}</h3>
                  <p class="text-xs text-gray-500 mt-0.5">{% trans "Model" %}: ${escapeHTML(kit.model || '‚Äî')}</p>
                </div>
                <span class="text-sm font-medium text-gray-900">${kit.price_usd ?? '‚Äî'} USD</span>
              </div>
              <p class="text-sm text-gray-700 mt-2">${escapeHTML(truncateWords(kit.description, 18))}</p>
              <div class="flex flex-wrap gap-2 mt-3">
                <button onclick="handleEditKit(${kit.id})"
                        class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium bg-yellow-100 text-yellow-700 hover:bg-yellow-200">
                  <i class="fas fa-edit mr-1"></i> {% trans "Edit" %}
                </button>
                <button onclick="deleteKit(${kit.id})"
                        class="inline-flex items-center px-3 py-1.5 rounded-md text-xs font-medium bg-red-100 text-red-700 hover:bg-red-200">
                  <i class="fas fa-trash-alt mr-1"></i> {% trans "Delete" %}
                </button>
              </div>
            </div>`;
          cards.insertAdjacentHTML("beforeend", card);
        });
      })
      .catch(error => {
        console.error("Error fetching kits:", error);
        document.getElementById("kit_table_body").innerHTML = `
          <tr><td colspan="5" class="text-center text-red-500 py-4">‚ùå {% trans "Failed to load kits." %}</td></tr>`;
        document.getElementById("kit_cards").innerHTML = `
          <div class="text-center text-red-500 py-6 border rounded-lg">‚ùå {% trans "Failed to load kits." %}</div>`;
      });
  }

  // Edit button logic to load and open modal
  function handleEditKit(id) {
    const url = "{% url 'get_kit' 0 %}".replace("0", id);
    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const kit = data.kit;
          document.getElementById("edit_kit_id").value = kit.id;
          document.getElementById("edit_name").value = kit.name || '';
          document.getElementById("edit_model").value = kit.model || '';
          document.getElementById("edit_description").value = kit.description || '';
          document.getElementById("edit_price_usd").value = kit.price_usd ?? '';
          openModal('hardware_edit');
        } else {
          alert("‚ùå " + (data.message || "{% trans 'Failed to load kit data.' %}"));
        }
      })
      .catch(error => {
        console.error("Error loading kit:", error);
        alert("‚ö†Ô∏è {% trans 'Could not fetch kit data.' %}");
      });
  }

  // Helper to truncate long text
  function truncateWords(text, limit) {
    if (!text) return '‚Äî';
    const words = (text + '').split(/\s+/);
    if (words.length <= limit) return text;
    return words.slice(0, limit).join(' ') + '‚Ä¶';
  }

  // Basic XSS-safe escaping for injected HTML text
  function escapeHTML(str) {
    return (str ?? '').toString()
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function getCSRFToken() {
    const tag = document.querySelector('meta[name="csrf-token"]');
    return tag ? tag.getAttribute('content') : '';
  }

  function deleteKit(id) {
    if (!confirm("{% trans 'Are you sure you want to delete this kit?' %}")) return;

    // If you have a named URL for deletion, prefer: const url = "{% url 'delete_kit' 0 %}".replace("0", id);
    const url = `/settings/kit/delete_kit/${id}/`;

    fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest"
      }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert("‚úÖ {% trans 'Kit deleted successfully!' %}");
        fetchKits();
      } else {
        alert("‚ùå " + (data.message || "{% trans 'Failed to delete kit.' %}"));
      }
    })
    .catch(err => {
      console.error("Delete error:", err);
      alert("‚ö†Ô∏è {% trans 'An error occurred while deleting the kit.' %}");
    });
  }
</script>
