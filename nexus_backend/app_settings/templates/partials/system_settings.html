{# partials/system_settings.html #}
{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}

<section class="rounded-2xl bg-white border border-gray-200 shadow-sm p-5 sm:p-6 card-hover animate-fade-in"
         id="systemSettings"
         data-update-url="{% url 'settings_company_update' %}">
  <!-- Section header -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-5">
    <div>
      <h2 class="text-lg sm:text-xl font-semibold text-gray-900">
        {% trans "System Settings â€” Company Profile" %}
      </h2>
      <p class="text-sm text-gray-500">
        {% trans "Master information used on invoices, receipts, and official notices in the DRC." %}
      </p>
    </div>
    <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 ring-1 ring-inset ring-indigo-600/20">
      {% trans "DRC Invoicing Ready" %}
    </span>
  </div>

  <!-- Layout: sticky tabs at left, content at right (on large screens) -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Sticky Sidebar Tabs -->
    <aside class="lg:col-span-3">
      <nav aria-label="{% trans 'Settings Sections' %}"
           class="sticky top-6 bg-white border rounded-xl shadow-sm p-2"
           role="tablist" aria-orientation="vertical">
        <button id="sys-tab-company" data-target="company" role="tab" aria-controls="sys-company" aria-selected="true"
                class="sys-link w-full flex items-center gap-3 px-3 py-2 rounded-lg bg-gray-900 text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
          <i class="fas fa-building text-sm"></i>
          <span>{% trans "Company" %}</span>
        </button>
        <button id="sys-tab-billing" data-target="billing" role="tab" aria-controls="sys-billing" aria-selected="false" tabindex="-1"
                class="sys-link w-full mt-1 flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
          <i class="fas fa-file-invoice-dollar text-sm"></i>
          <span>{% trans "Billing Defaults" %}</span>
        </button>
        <button id="sys-tab-branding" data-target="branding" role="tab" aria-controls="sys-branding" aria-selected="false" tabindex="-1"
                class="sys-link w-full mt-1 flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
          <i class="fas fa-stamp text-sm"></i>
          <span>{% trans "Branding" %}</span>
        </button>
        <button id="sys-tab-compliance" data-target="compliance" role="tab" aria-controls="sys-compliance" aria-selected="false" tabindex="-1"
                class="sys-link w-full mt-1 flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
          <i class="fas fa-shield-alt text-sm"></i>
          <span>{% trans "Compliance & Legal" %}</span>
        </button>
      </nav>
    </aside>

    <!-- Content Panels -->
    <section class="lg:col-span-9">
      <div id="sysPanels" class="rounded-2xl border shadow-sm ring-1 ring-black/5 overflow-hidden"
           data-update-url="{% url 'settings_company_update' %}">
        <!-- COMPANY -->
        <div id="sys-company" class="p-4 sm:p-6" role="tabpanel" aria-labelledby="sys-tab-company">
          <div class="mb-6">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">{% trans "Company Identity" %}</h3>
            <p class="text-sm text-gray-600">{% trans "Legal details and contact information printed on all documents." %}</p>
          </div>

          <form id="companyForm" class="space-y-8" enctype="multipart/form-data">
            <!-- Identity -->
            <div class="rounded-xl border p-4 sm:p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">{% trans "Identity" %}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Registered / Legal Name" %}</label>
                  <input name="legal_name" type="text" value="{{ company.legal_name|default:'' }}" required
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Trade Name (optional)" %}</label>
                  <input name="trade_name" type="text" value="{{ company.trade_name|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Primary Email" %}</label>
                  <input name="email" type="email" value="{{ company.email|default:'' }}" required
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Primary Phone" %}</label>
                  <input name="phone" type="text" value="{{ company.phone|default:'' }}" required
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500" placeholder="+243 ...">
                </div>
                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700">{% trans "Website" %}</label>
                  <input name="website" type="url" value="{{ company.website|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500" placeholder="https://...">
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="rounded-xl border p-4 sm:p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">{% trans "Address" %}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Street Address" %}</label>
                  <input name="street_address" type="text" value="{{ company.street_address|default:'' }}" required
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "City" %}</label>
                  <input name="city" type="text" value="{{ company.city|default:'' }}" required
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Province" %}</label>
                  <input name="province" type="text" value="{{ company.province|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Country" %}</label>
                  <input name="country" type="text" value="{{ company.country|default:'RDC' }}" required
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Postal Code" %}</label>
                  <input name="postal_code" type="text" value="{{ company.postal_code|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
              </div>
            </div>

            <!-- Legal (DRC) -->
            <div class="rounded-xl border p-4 sm:p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">{% trans "Legal Identifiers (DRC)" %}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "RCCM" %}</label>
                  <input name="rccm" type="text" value="{{ company.rccm|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500"
                         placeholder="CD/LSHI/RCCM/19-A-00050">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Id.Nat" %}</label>
                  <input name="id_nat" type="text" value="{{ company.id_nat|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500"
                         placeholder="0009000">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "NIF (Tax ID)" %}</label>
                  <input name="nif" type="text" value="{{ company.nif|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500"
                         placeholder="A1234567890B">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">
                    {% trans "ARPTC License" %}
                    <span class="text-xs text-gray-500">({% trans "Telecom Regulator" %})</span>
                  </label>
                  <input name="arptc_license" type="text" value="{{ company.arptc_license|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500"
                         placeholder="ARPTC-12345">
                </div>
              </div>
              {# ðŸ”» Removed tax_regime, tva_rate_percent, and excise_rate_percent fields per request #}
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end gap-3">
              <button type="button" onclick="window.history.back()"
                      class="px-4 py-2 rounded-lg border hover:bg-gray-50">
                {% trans "Cancel" %}
              </button>
              <button id="saveCompanyBtn" type="submit"
                      class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
                {% trans "Save" %}
              </button>
            </div>
          </form>
        </div>

        <hr>

        <!-- BILLING DEFAULTS -->
        <div id="sys-billing" class="p-4 sm:p-6 hidden" role="tabpanel" aria-labelledby="sys-tab-billing">
          <div class="mb-6">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">{% trans "Billing Defaults" %}</h3>
            <p class="text-sm text-gray-600">{% trans "Numbering, currency, payment terms, and invoice footers." %}</p>
          </div>

          <form id="billingForm" class="space-y-8">
            <div class="rounded-xl border p-4 sm:p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">{% trans "Invoice Numbering" %}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Invoice Prefix" %}</label>
                  <input name="invoice_prefix" type="text" value="{{ company.invoice_prefix|default:'INV' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Next Invoice #" %}</label>
                  <input name="next_invoice_number" type="number" min="1"
                         value="{{ company.next_invoice_number|default:1 }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex items-end">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" name="reset_number_annually_cb"
                           {% if company.reset_number_annually %}checked{% endif %}
                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <span class="text-sm text-gray-700">{% trans "Reset numbering annually" %}</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="rounded-xl border p-4 sm:p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">{% trans "Currency & Terms" %}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Default Currency" %}</label>
                  <select name="default_currency" class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    <option value="USD" {% if company.default_currency == 'USD' %}selected{% endif %}>USD</option>
                    <option value="CDF" {% if company.default_currency == 'CDF' %}selected{% endif %}>CDF</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Payment Terms (days)" %}</label>
                  <input name="payment_terms_days" type="number" min="0" max="365"
                         value="{{ company.payment_terms_days|default:7 }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex items-end">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" name="show_prices_in_cdf_cb"
                           {% if company.show_prices_in_cdf %}checked{% endif %}
                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <span class="text-sm text-gray-700">{% trans "Also display amounts in CDF" %}</span>
                  </label>
                </div>

              </div>
            </div>

            <div class="rounded-xl border p-4 sm:p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">{% trans "Payment Instructions & Footers" %}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Payment Instructions" %}</label>
                  <textarea name="payment_instructions" rows="3"
                            class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500"
                            placeholder="{% trans 'Bank references, deadlines, penalties, etc.' %}">{{ company.payment_instructions|default:'' }}</textarea>
                </div>
                <div class="space-y-4">
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700">{% trans "Bank Name" %}</label>
                      <input name="bank_name" type="text" value="{{ company.bank_name|default:'' }}"
                             class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700">{% trans "Branch" %}</label>
                      <input name="bank_branch" type="text" value="{{ company.bank_branch|default:'' }}"
                             placeholder="{% trans 'e.g., Lubumbashi' %}"
                             class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700">{% trans "Account Name" %}</label>
                      <input name="bank_account_name" type="text" value="{{ company.bank_account_name|default:'' }}"
                             class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700">{% trans "Account Number (USD)" %}</label>
                      <input name="bank_account_number_usd" type="text" value="{{ company.bank_account_number_usd|default:'' }}"
                             class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700">{% trans "Account Number (CDF)" %}</label>
                      <input name="bank_account_number_cdf" type="text" value="{{ company.bank_account_number_cdf|default:'' }}"
                             class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700">{% trans "IBAN" %}</label>
                      <input name="bank_iban" type="text" value="{{ company.bank_iban|default:'' }}"
                             class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700">{% trans "SWIFT/BIC" %}</label>
                      <input name="bank_swift" type="text" value="{{ company.bank_swift|default:'' }}"
                             class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">{% trans "Invoice Footer (FR)" %}</label>
                    <textarea name="footer_text_fr" rows="3"
                              class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">{{ company.footer_text_fr|default:'' }}</textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">{% trans "Invoice Footer (EN)" %}</label>
                    <textarea name="footer_text_en" rows="3"
                              class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">{{ company.footer_text_en|default:'' }}</textarea>
                  </div>
                </div>
              </div>
              <p class="mt-3 text-xs text-gray-500">
                {% trans "Tip: Manage bank accounts and branches in Admin to print the correct coordinates and addresses." %}
              </p>
            </div>

            <div class="flex items-center justify-end gap-3">
              <button type="button" onclick="window.history.back()" class="px-4 py-2 rounded-lg border hover:bg-gray-50">{% trans "Cancel" %}</button>
              <button id="saveBillingBtn" type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">{% trans "Save" %}</button>
            </div>
          </form>
        </div>

        <hr>

        <!-- BRANDING -->
        <div id="sys-branding" class="p-4 sm:p-6 hidden" role="tabpanel" aria-labelledby="sys-tab-branding">
          <div class="mb-6">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">{% trans "Branding" %}</h3>
            <p class="text-sm text-gray-600">{% trans "Logos, stamps, signatures, and signatory details for PDFs." %}</p>
          </div>

          <form id="brandingForm" class="space-y-8" enctype="multipart/form-data">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Logo -->
              <div class="rounded-xl border p-4 sm:p-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">{% trans "Logo" %}</h4>
                <div class="block">
                  <div id="logoDrop" class="mt-1 flex items-center justify-center h-32 rounded-lg border-2 border-dashed border-gray-300 hover:border-indigo-400 cursor-pointer bg-gray-50">
                    <div class="text-center">
                      <p class="text-xs text-gray-600">{% trans "Drag & drop or click to upload" %}</p>
                      <p class="text-[11px] text-gray-500">{% trans "PNG/SVG preferred" %}</p>
                    </div>
                  </div>
                </div>
                <input id="logoInput" name="logo" type="file" accept="image/*" class="hidden">
                <div class="mt-3 flex items-center gap-3">
                  <img id="logoPreview"
                       {% if company.logo %} src="{{ company.logo.url }}"{% else %} src="{% static 'img/placeholder-logo.svg' %}"{% endif %}
                       alt="Logo preview" class="max-h-16 object-contain">
                  {% if company.logo %}
                    <button type="button" onclick="deleteCompanyFile('logo')"
                            class="px-3 py-1.5 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                      <svg class="inline-block w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                      {% trans "Delete" %}
                    </button>
                  {% endif %}
                </div>
              </div>

              <!-- Stamp -->
              <div class="rounded-xl border p-4 sm:p-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">{% trans "Company Stamp" %}</h4>
                <div class="block">
                  <div id="stampDrop" class="mt-1 flex items-center justify-center h-32 rounded-lg border-2 border-dashed border-gray-300 hover:border-indigo-400 cursor-pointer bg-gray-50">
                    <div class="text-center">
                      <p class="text-xs text-gray-600">{% trans "Drag & drop or click to upload" %}</p>
                      <p class="text-[11px] text-gray-500">{% trans "PNG recommended" %}</p>
                    </div>
                  </div>
                </div>
                <input id="stampInput" name="stamp" type="file" accept="image/*" class="hidden">
                <div class="mt-3 flex items-center gap-3">
                  <img id="stampPreview"
                       {% if company.stamp %} src="{{ company.stamp.url }}"{% else %} src="{% static 'img/placeholder-stamp.png' %}"{% endif %}
                       alt="Stamp preview" class="max-h-16 object-contain">
                  {% if company.stamp %}
                    <button type="button" onclick="deleteCompanyFile('stamp')"
                            class="px-3 py-1 text-xs font-medium text-red-600 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500">
                      <i class="fas fa-trash mr-1"></i>{% trans "Delete" %}
                    </button>
                  {% endif %}
                </div>
              </div>

              <!-- Signature -->
              <div class="rounded-xl border p-4 sm:p-6">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">{% trans "Signature" %}</h4>
                <div class="block">
                  <div id="signatureDrop" class="mt-1 flex items-center justify-center h-32 rounded-lg border-2 border-dashed border-gray-300 hover:border-indigo-400 cursor-pointer bg-gray-50">
                    <div class="text-center">
                      <p class="text-xs text-gray-600">{% trans "Drag & drop or click to upload" %}</p>
                      <p class="text-[11px] text-gray-500">{% trans "Transparent PNG if possible" %}</p>
                    </div>
                  </div>
                </div>
                <input id="signatureInput" name="signature" type="file" accept="image/*" class="hidden">
                <div class="mt-3 flex items-center gap-3">
                  <img id="signaturePreview"
                       {% if company.signature %} src="{{ company.signature.url }}"{% else %} src="{% static 'img/placeholder-signature.png' %}"{% endif %}
                       alt="Signature preview" class="max-h-16 object-contain">
                  {% if company.signature %}
                    <button type="button" onclick="deleteCompanyFile('signature')"
                            class="px-3 py-1 text-xs font-medium text-red-600 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500">
                      <i class="fas fa-trash mr-1"></i>{% trans "Delete" %}
                    </button>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="rounded-xl border p-4 sm:p-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-4">{% trans "Signatory" %}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Signatory Name" %}</label>
                  <input name="signatory_name" type="text" value="{{ company.signatory_name|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Signatory Title" %}</label>
                  <input name="signatory_title" type="text" value="{{ company.signatory_title|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500" placeholder="{% trans 'Finance Manager' %}">
                </div>
              </div>
            </div>

            <div class="flex items-center justify-end gap-3">
              <button type="button" onclick="window.history.back()" class="px-4 py-2 rounded-lg border hover:bg-gray-50">{% trans "Cancel" %}</button>
              <button id="saveBrandingBtn" type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">{% trans "Save" %}</button>
            </div>
          </form>
        </div>

        <hr>

        <!-- COMPLIANCE & LEGAL -->
        <div id="sys-compliance" class="p-4 sm:p-6 hidden" role="tabpanel" aria-labelledby="sys-tab-compliance">
          <div class="mb-6">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">{% trans "Compliance & Legal" %}</h3>
            <p class="text-sm text-gray-600">{% trans "Optional fields printed in headers/footers when relevant." %}</p>
          </div>

          <form id="complianceForm" class="space-y-8">
            <div class="rounded-xl border p-4 sm:p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">{% trans "Tax Office / Directorate" %}</label>
                  <input name="tax_office_name" type="text" value="{{ company.tax_office_name|default:'' }}"
                         class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500">
                </div>
              </div>
              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700">{% trans "Legal Notes" %}</label>
                <textarea name="legal_notes" rows="4"
                          class="mt-1 w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-500"
                          placeholder="{% trans 'Exemptions and legal bases to print on invoice when applicable.' %}">{{ company.legal_notes|default:'' }}</textarea>
              </div>
            </div>

            <div class="flex items-center justify-end gap-3">
              <button type="button" onclick="window.history.back()" class="px-4 py-2 rounded-lg border hover:bg-gray-50">{% trans "Cancel" %}</button>
              <button id="saveComplianceBtn" type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">{% trans "Save" %}</button>
            </div>
          </form>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="sysToast" class="fixed bottom-4 right-4 hidden z-50">
    <div id="sysToastBox" class="rounded-lg shadow-lg bg-gray-900 text-white px-4 py-3 text-sm"></div>
  </div>
</section>

<script>
/* ===== Delete company file - Global function for onclick ===== */
function deleteCompanyFile(fieldName) {
  if (!confirm(`{% trans "Are you sure you want to delete this" %} ${fieldName}?`)) {
    return;
  }

  const btn = event.target.closest('button');
  if (btn) btn.disabled = true;

  fetch("{% url 'settings_company_delete_file' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: new URLSearchParams({ field_name: fieldName })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert(data.message || `${fieldName} deleted successfully`);
      // Reload page to update UI
      setTimeout(() => window.location.reload(), 1000);
    } else {
      alert(data.message || 'Failed to delete file');
      if (btn) btn.disabled = false;
    }
  })
  .catch(err => {
    console.error('Delete error:', err);
    alert('An error occurred while deleting the file');
    if (btn) btn.disabled = false;
  });
}

/* ===== Helpers (scoped for this partial) ===== */
(function(){
  const root = document.getElementById('systemSettings');
  if(!root) return;

  const panelsWrap = document.getElementById('sysPanels');
  const updateUrl = panelsWrap?.dataset.updateUrl || root.dataset.updateUrl;

  function getCookie(name){
    let cookieValue=null;
    if(document.cookie && document.cookie!==''){
      for(const c of document.cookie.split(';')){
        const cookie=c.trim();
        if(cookie.substring(0,name.length+1)===(name+'=')){
          cookieValue=decodeURIComponent(cookie.substring(name.length+1)); break;
        }
      }
    }
    return cookieValue;
  }
  function csrfHeader(){ const t=getCookie('csrftoken'); return t?{'X-CSRFToken':t}:{ }; }
  function toast(msg, ok=true){
    const t=document.getElementById('sysToast'); const b=document.getElementById('sysToastBox');
    if(!t||!b) return alert(msg);
    b.textContent=msg;
    b.className=`rounded-lg shadow-lg px-4 py-3 text-sm ${ok?'bg-gray-900 text-white':'bg-red-600 text-white'}`;
    t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2600);
  }
  function boolField(formEl, checkboxName, targetName){
    const cb=formEl.querySelector(`[name="${checkboxName}"]`);
    return { [targetName]: (cb && cb.checked) ? 1 : 0 };
  }
  async function submitForm(formEl, btnEl, extra=null){
    const fd=new FormData(formEl);
    if(extra) Object.entries(extra).forEach(([k,v])=>fd.append(k,v));
    btnEl.disabled=true; const old=btnEl.textContent; btnEl.textContent='{{ _("Savingâ€¦") }}';
    try{
      const r=await fetch(updateUrl, {method:'POST', headers: csrfHeader(), body: fd});
      const data=await r.json().catch(()=> ({}));
      if(!r.ok || data?.ok===false) throw new Error(data?.error || r.statusText);
      toast('{{ _("Saved successfully") }}');
    }catch(err){ console.error(err); toast(err.message || 'Error', false); }
    finally{ btnEl.disabled=false; btnEl.textContent=old; }
  }

  /* ===== Tabs wiring (accessible, keyboard-friendly) ===== */
  const links = Array.from(root.querySelectorAll('.sys-link[role="tab"]'));
  const panels = {
    company: document.getElementById('sys-company'),
    billing: document.getElementById('sys-billing'),
    branding: document.getElementById('sys-branding'),
    compliance: document.getElementById('sys-compliance'),
  };

  function setActiveVisual(btn, active){
    if(active){
      btn.classList.add('bg-gray-900','text-white');
      btn.classList.remove('hover:bg-gray-50');
    }else{
      btn.classList.remove('bg-gray-900','text-white');
      btn.classList.add('hover:bg-gray-50');
    }
  }

  function activateTab(target, {setFocus=false, persist=true}={}){
    const btn = links.find(b=> b.dataset.target===target);
    const panel = panels[target];
    if(!btn || !panel) return;

    // Update buttons
    links.forEach(b=>{
      const isActive = b===btn;
      b.setAttribute('aria-selected', isActive? 'true':'false');
      b.tabIndex = isActive? 0 : -1;
      setActiveVisual(b, isActive);
    });

    // Update panels
    Object.entries(panels).forEach(([key, p])=>{
      const show = key===target;
      if(show){ p.classList.remove('hidden'); p.setAttribute('aria-hidden','false'); }
      else { p.classList.add('hidden'); p.setAttribute('aria-hidden','true'); }
    });

    // Persist + URL
    if(persist){
      try{ localStorage.setItem('sysSettingsTab', target); }catch(e){}
      if(history.replaceState){ history.replaceState(null, '', `#${target}`); }
      else { location.hash = target; }
    }

    if(setFocus) btn.focus();
  }

  // Click handling
  links.forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const target = btn.getAttribute('data-target');
      activateTab(target, {setFocus:false});
    });

    // Keyboard handling per WAI-ARIA Authoring Practices
    btn.addEventListener('keydown', (e)=>{
      const currentIndex = links.indexOf(btn);
      let nextIndex = null;
      switch(e.key){
        case 'ArrowDown':
        case 'ArrowRight':
          nextIndex = (currentIndex + 1) % links.length; break;
        case 'ArrowUp':
        case 'ArrowLeft':
          nextIndex = (currentIndex - 1 + links.length) % links.length; break;
        case 'Home': nextIndex = 0; break;
        case 'End': nextIndex = links.length - 1; break;
        case 'Enter':
        case ' ':
          activateTab(btn.dataset.target, {setFocus:false}); return; // space
      }
      if(nextIndex!==null){
        e.preventDefault();
        const next = links[nextIndex];
        next.focus();
        activateTab(next.dataset.target, {setFocus:false});
      }
    });
  });

  // Initial activation: URL hash > localStorage > default 'company'
  (function initTabs(){
    const hash = (location.hash || '').replace('#','');
    const saved = (()=>{ try{ return localStorage.getItem('sysSettingsTab') || ''; }catch(e){ return ''; } })();
    const initial = ['company','billing','branding','compliance'].includes(hash)? hash
                   : ['company','billing','branding','compliance'].includes(saved)? saved
                   : 'company';
    activateTab(initial, {setFocus:false, persist:false});
  })();

  /* ===== File drop previews (branding) ===== */
  function bindFileDrop(dropId, inputId, imgId){
    const drop=document.getElementById(dropId);
    const input=document.getElementById(inputId);
    const img=document.getElementById(imgId);
    if(!drop||!input) return;
    drop.addEventListener('click', ()=> input.click());
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('border-indigo-500'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('border-indigo-500'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('border-indigo-500');
      const files = e.dataTransfer.files;
      if(files && files.length > 0){
        // Create a new DataTransfer object and assign it to the input
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        input.files = dt.files;
        if(img) img.src = URL.createObjectURL(files[0]);
      }
    });
    input.addEventListener('change', e=>{
      const file=e.target.files?.[0]; if(file&&img){ img.src=URL.createObjectURL(file); }
    });
  }
  bindFileDrop('logoDrop','logoInput','logoPreview');
  bindFileDrop('stampDrop','stampInput','stampPreview');
  bindFileDrop('signatureDrop','signatureInput','signaturePreview');

  /* ===== Form submissions ===== */
  document.getElementById('saveCompanyBtn')?.addEventListener('click', e=>{
    e.preventDefault();
    submitForm(document.getElementById('companyForm'), e.currentTarget, {_section:'company'});
  });

  document.getElementById('saveBillingBtn')?.addEventListener('click', e=>{
    e.preventDefault();
    const form=document.getElementById('billingForm');
    const extras={
      _section:'billing',
      ...boolField(form,'reset_number_annually_cb','reset_number_annually'),
      ...boolField(form,'show_prices_in_cdf_cb','show_prices_in_cdf'),
    };
    submitForm(form, e.currentTarget, extras);
  });

  document.getElementById('saveBrandingBtn')?.addEventListener('click', e=>{
    e.preventDefault();
    submitForm(document.getElementById('brandingForm'), e.currentTarget, {_section:'branding'});
  });

  document.getElementById('saveComplianceBtn')?.addEventListener('click', e=>{
    e.preventDefault();
    submitForm(document.getElementById('complianceForm'), e.currentTarget, {_section:'compliance'});
  });
})();
</script>
