{% load i18n %}

<!-- Add Payment Method Modal -->
<div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md relative">
    <!-- Close Button -->
    <button onclick="closePaymentModal()" class="absolute top-2 right-2 text-gray-500 hover:text-red-500">
      <i class="fas fa-times"></i>
    </button>

    <h2 class="text-xl font-semibold mb-4">{% trans "Add Payment Method" %}</h2>
    <form id="paymentForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium">{% trans "Method" %}</label>
        <select name="method" id="paymentMethodSelect" required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300">
          <option value="" disabled selected>{% trans "Select a payment method" %}</option>
          <!-- JS will fill here -->
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium">{% trans "Description (optional)" %}</label>
        <textarea name="description"
               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-300"></textarea>
      </div>

      <button type="submit"
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
        {% trans "Add Method" %}
      </button>
    </form>
  </div>
</div>

<script>
  // Load choices dynamically
  async function loadPaymentChoices() {
    try {
      const res = await fetch("{% url 'payment_choices' %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
      const data = await res.json();
      const sel = document.getElementById('paymentMethodSelect');
      sel.innerHTML = '<option value="" disabled selected>{{ _("Select a payment method") }}</option>';

      if (data.success && Array.isArray(data.choices)) {
        data.choices.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.value;
          opt.textContent = c.label;
          sel.appendChild(opt);
        });
      }
    } catch (e) {
      console.error("Failed to load payment choices", e);
    }
  }

  document.addEventListener('DOMContentLoaded', loadPaymentChoices);

   const modal = document.getElementById("paymentModal");

  function openPaymentModal() {
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden"); // prevent background scroll
    loadPaymentChoices(); // load choices each time modal opens
  }

  function closePaymentModal() {
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  }

  // Close modal when clicking on overlay (background)
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      closePaymentModal();
    }
  });

  // ESC key support
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) {
      closePaymentModal();
    }
  });

    // Helper (reuse yours if already defined)
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let c of cookies) {
        c = c.trim();
        if (c.substring(0, name.length + 1) === (name + '=')) {
          v = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }

  const paymentForm = document.getElementById('paymentForm');

  paymentForm?.addEventListener('submit', async function (e) {
    e.preventDefault();

    const submitBtn = paymentForm.querySelector('button[type="submit"]');
    const methodSel  = document.getElementById('paymentMethodSelect');
    const description = (paymentForm.querySelector('textarea[name="description"]')?.value || '').trim();

    // Basic validation
    if (!methodSel?.value) {
      alert("{% trans 'Please select a payment method.' %}");
      methodSel?.focus();
      return;
    }

    // Build payload expected by your view
    const payload = {
      // Backend expects "name" for PaymentMethod.name (mapped from the predefined choice)
      name: methodSel.value,
      description: description,
    };

    // Busy state
    const originalText = submitBtn?.textContent;
    submitBtn && (submitBtn.disabled = true);
    submitBtn && (submitBtn.textContent = "{% trans 'Savingâ€¦' %}");

    try {
      const res = await fetch("{% url 'payments_method_add' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json();

      if (!res.ok || data.success === false) {
        throw new Error(data.message || "{% trans 'Failed to save payment method.' %}");
      }

      alert(data.message || "{% trans 'Saved' %}");

      // Reset and close
      paymentForm.reset();
      closePaymentModal?.();

      // Refresh the listing table if you have this function
      typeof loadPaymentMethods === 'function' && loadPaymentMethods();

    } catch (err) {
      console.error(err);
      alert(err.message || "{% trans 'Error saving payment method' %}");
    } finally {
      submitBtn && (submitBtn.disabled = false);
      submitBtn && (submitBtn.textContent = originalText || "{% trans 'Add Method' %}");
    }
  });
</script>
