{% extends 'tech/fe_dashboard_main.html' %}
{% load static %}

{% block content %}
    <div class="w-full px-6 py-6">
        <!-- Gradient Header -->
        <header class="rounded-2xl bg-gradient-to-r from-indigo-500 via-blue-500 to-sky-400 p-6 shadow-lg text-white mb-8 animate-fade-in">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-3">
                    <i class="fas fa-clipboard-check text-3xl opacity-90"></i>
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Site Survey Management</h1>
                        <p class="text-indigo-100 text-sm mt-1">Manage site surveys for Starlink installations.</p>
                    </div>
                </div>
                <button onclick="loadSurveys()" class="inline-flex items-center gap-2 bg-white/95 text-indigo-700 hover:bg-white px-4 py-2 rounded-lg font-medium shadow-sm">
                    <i class="fas fa-rotate"></i> Refresh
                </button>
            </div>
        </header>

        <!-- Summary Section -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <!-- Scheduled Surveys -->
            <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 border border-indigo-200 rounded-2xl shadow-lg p-5 transform hover:scale-105 transition-all duration-300 ease-in-out">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-indigo-700">Scheduled</span>
                    <span class="text-indigo-500 animate-bounce">üìÖ</span>
                </div>
                <div class="text-3xl font-bold text-indigo-800 mt-3" id="scheduledCount">0</div>
                <p class="text-xs text-indigo-600 mt-2">Surveys scheduled</p>
            </div>

            <!-- In Progress -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-2xl shadow-lg p-5 transform hover:scale-105 transition-all duration-300 ease-in-out">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-blue-700">In Progress</span>
                    <span class="text-blue-500 animate-pulse">üîÑ</span>
                </div>
                <div class="text-3xl font-bold text-blue-800 mt-3" id="inProgressCount">0</div>
                <p class="text-xs text-blue-600 mt-2">Surveys being conducted</p>
            </div>

            <!-- Completed -->
            <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 border border-yellow-200 rounded-2xl shadow-lg p-5 transform hover:scale-105 transition-all duration-300 ease-in-out">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-yellow-700">Completed</span>
                    <span class="text-yellow-500 animate-spin">‚úÖ</span>
                </div>
                <div class="text-3xl font-bold text-yellow-800 mt-3" id="completedCount">0</div>
                <p class="text-xs text-yellow-600 mt-2">Awaiting approval</p>
            </div>

            <!-- Approved -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-2xl shadow-lg p-5 transform hover:scale-105 transition-all duration-300 ease-in-out">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-green-700">Approved</span>
                    <span class="text-green-500 animate-bounce">üëç</span>
                </div>
                <div class="text-3xl font-bold text-green-800 mt-3" id="approvedCount">0</div>
                <p class="text-xs text-green-600 mt-2">Ready for installation</p>
            </div>
        </div>

        <!-- Survey List Table -->
        <div class="bg-white border border-gray-200 rounded-2xl shadow p-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Site Surveys</h2>

            <!-- Filter Section -->
            <div class="mb-4 flex items-center space-x-4">
                <label for="statusFilter" class="text-sm font-medium text-gray-700">Filter by Status:</label>
                <select id="statusFilter" onchange="applyFilter()" class="border border-gray-300 text-sm rounded px-3 py-2">
                    <option value="All">All</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3">#</th>
                        <th class="px-4 py-3">Order Ref</th>
                        <th class="px-4 py-3">Technician</th>
                        <th class="px-4 py-3">Scheduled at</th>
                        <th class="px-4 py-3">Status</th>
                        <th class="px-4 py-3">Location</th>
                        <th class="px-4 py-3 text-center">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="surveysTableBody" class="divide-y divide-gray-100">
                    <!-- Populated dynamically with JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allSurveys = [];

        function getCSRFToken() {
            const name = "csrftoken";
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    return decodeURIComponent(cookie.substring(name.length + 1));
                }
            }
            return null;
        }

        async function loadSurveys() {
            try {
                const response = await fetch("{% url 'survey_dashboard' %}");
                const data = await response.json();
                allSurveys = data.surveys || [];
                renderSurveys(allSurveys);
            } catch (error) {
                console.error("Error loading surveys:", error);
            }
        }

        function applyFilter() {
            const selectedStatus = document.getElementById("statusFilter").value;
            const filteredSurveys = selectedStatus === "All" ? allSurveys : allSurveys.filter(survey => survey.status === selectedStatus);
            renderSurveys(filteredSurveys);
        }

        function renderSurveys(surveys) {
            const tbody = document.getElementById("surveysTableBody");
            const scheduledCount = document.getElementById("scheduledCount");
            const inProgressCount = document.getElementById("inProgressCount");
            const completedCount = document.getElementById("completedCount");
            const approvedCount = document.getElementById("approvedCount");

            tbody.innerHTML = "";
            let index = 1;
            let scheduled = 0, progress = 0, completed = 0, approved = 0;

            surveys.forEach(survey => {
                if (survey.status === "scheduled") scheduled++;
                else if (survey.status === "in_progress") progress++;
                else if (survey.status === "completed") completed++;
                else if (survey.status === "approved") approved++;

                const locationLink = survey.latitude && survey.longitude ?
                    `<a href="https://maps.google.com/?q=${survey.latitude},${survey.longitude}" target="_blank" class="text-blue-500 hover:underline">View</a>` : 'N/A';

                let actionButtons = '';
                if (survey.status === "completed") {
                    actionButtons += `
                        <button onclick="approveSurvey(${survey.id})" class="bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600">Approve</button>
                        <button onclick="rejectSurvey(${survey.id})" class="bg-red-500 text-white text-xs px-3 py-1 rounded hover:bg-red-600">Reject</button>
                    `;
                }

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="px-4 py-2">${index++}</td>
                    <td class="px-4 py-2 font-medium">${survey.order_reference}</td>
                    <td class="px-4 py-2">${survey.technician || 'Unassigned'}</td>
                    <td class="px-4 py-2">${survey.scheduled_at || '‚Äî'}</td>
                    <td class="px-4 py-2 capitalize">${survey.status.replace('_', ' ')}</td>
                    <td class="px-4 py-2">${locationLink}</td>
                    <td class="px-4 py-2 text-center space-y-1">
                        <a href="/tech/surveys/${survey.id}/" class="block bg-blue-500 text-white text-xs px-3 py-1 rounded hover:bg-blue-600">View Details</a>
                        ${actionButtons}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            scheduledCount.textContent = scheduled;
            inProgressCount.textContent = progress;
            completedCount.textContent = completed;
            approvedCount.textContent = approved;
        }

        async function approveSurvey(surveyId) {
            if (!confirm("Are you sure you want to approve this survey?")) return;

            try {
                const res = await fetch(`/tech/surveys/${surveyId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({
                        action: "approve",
                        approval_notes: "Approved via dashboard"
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert("Survey approved successfully!");
                    loadSurveys(); // Refresh the surveys list
                } else {
                    alert(data.message || "Failed to approve survey.");
                }
            } catch (err) {
                console.error(err);
                alert("Something went wrong.");
            }
        }

        async function rejectSurvey(surveyId) {
            const reason = prompt("Please provide a reason for rejection:");
            if (!reason) return;

            try {
                const res = await fetch(`/tech/surveys/${surveyId}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({
                        action: "reject",
                        rejection_reason: reason
                    })
                });

                const data = await res.json();
                if (data.success) {
                    alert("Survey rejected.");
                    loadSurveys(); // Refresh the surveys list
                } else {
                    alert(data.message || "Failed to reject survey.");
                }
            } catch (err) {
                console.error(err);
                alert("Something went wrong.");
            }
        }

        window.addEventListener("DOMContentLoaded", loadSurveys);
    </script>
{% endblock %}
