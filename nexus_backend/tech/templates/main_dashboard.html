{% extends 'tech/main_dashboard.html' %}
{% load static %}

{% block content %}
<div class="w-full px-6 py-6">

  <!-- Gradient Header -->
  <header class="rounded-2xl bg-gradient-to-r from-indigo-500 via-blue-500 to-sky-400 p-6 shadow-lg text-white mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/15 shadow-inner">
          <i class="fas fa-screwdriver-wrench text-2xl opacity-90"></i>
        </span>
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">FE Dispatch Dashboard</h1>
          <p class="text-indigo-100 text-sm mt-1">Assign jobs, monitor progress, and review completions at a glance.</p>
        </div>
      </div>
      <button onclick="refreshJobs()" class="inline-flex items-center gap-2 bg-white/95 text-indigo-700 hover:bg-white px-4 py-2 rounded-lg font-medium shadow-sm">
        <i class="fas fa-rotate"></i> Refresh
      </button>
    </div>
  </header>

  <!-- Filters -->
  <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
    <select id="filterStatus" class="w-full border border-gray-300 p-2 rounded-lg bg-white hover:bg-gray-50 focus:ring-2 focus:ring-indigo-500">
      <option value="">All Statuses</option>
      <option value="Pending">Pending</option>
      <option value="In Progress">In Progress</option>
      <option value="Completed">Completed</option>
    </select>
    <select id="filterTechnician" class="w-full border border-gray-300 p-2 rounded-lg bg-white hover:bg-gray-50 focus:ring-2 focus:ring-indigo-500">
      <option value="">All Technicians</option>
    </select>
    <input type="text" id="searchInput" class="w-full border border-gray-300 p-2 rounded-lg bg-white hover:bg-gray-50 focus:ring-2 focus:ring-indigo-500" placeholder="Search by customer or order ref">
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-gradient-to-r from-blue-50 to-blue-100 shadow-lg rounded-2xl p-5 border border-blue-200">
      <div class="flex items-center justify-between">
        <span class="text-sm font-medium text-blue-700">Pending Assignment</span>
        <span class="text-blue-500">üõ†Ô∏è</span>
      </div>
      <div class="text-3xl font-bold text-blue-800 mt-3" id="pendingAssignCount">0</div>
    </div>
    <div class="bg-gradient-to-r from-indigo-50 to-indigo-100 shadow-lg rounded-2xl p-5 border border-indigo-200">
      <div class="flex items-center justify-between">
        <span class="text-sm font-medium text-indigo-700">Pending Installations</span>
        <span class="text-indigo-500">üì¶</span>
      </div>
      <div class="text-3xl font-bold text-indigo-800 mt-3" id="pendingCount">0</div>
    </div>
    <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 shadow-lg rounded-2xl p-5 border border-yellow-200">
      <div class="flex items-center justify-between">
        <span class="text-sm font-medium text-yellow-700">In Progress</span>
        <span class="text-yellow-500">‚öôÔ∏è</span>
      </div>
      <div class="text-3xl font-bold text-yellow-800 mt-3" id="progressCount">0</div>
    </div>
    <div class="bg-gradient-to-r from-green-50 to-green-100 shadow-lg rounded-2xl p-5 border border-green-200">
      <div class="flex items-center justify-between">
        <span class="text-sm font-medium text-green-700">Completed</span>
        <span class="text-green-500">‚úÖ</span>
      </div>
      <div class="text-3xl font-bold text-green-800 mt-3" id="completedCount">0</div>
    </div>
  </div>

  <!-- Jobs Table -->
  <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-700">Technician Installation Jobs</h2>
      <button onclick="refreshJobs()" class="text-sm text-blue-600 hover:underline">Refresh</button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
          <tr>
            <th class="px-4 py-3">#</th>
            <th class="px-4 py-3">Order Ref</th>
            <th class="px-4 py-3">Customer</th>
            <th class="px-4 py-3">Phone</th>
            <th class="px-4 py-3">Location</th>
            <th class="px-4 py-3">Technician</th>
            <th class="px-4 py-3">Scheduled at</th>
            <th class="px-4 py-3">Started at</th>
            <th class="px-4 py-3">Completed at</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody id="jobList" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Assign Modal -->
<div id="assignModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md border border-gray-200">
    <div class="flex items-start justify-between">
      <h2 class="text-xl font-semibold">Assign Technician</h2>
      <button class="text-gray-500 hover:text-gray-700" onclick="closeAssignModal()"><i class="fas fa-times"></i></button>
    </div>
    <p class="mb-4 mt-2 text-sm text-gray-600">Order Ref: <span id="assignModalOrderRef" class="font-bold text-gray-900"></span></p>

    <label class="block mb-2 text-sm font-medium">Select Technician</label>
    <select id="assignTechnicianSelect" class="w-full border border-gray-300 p-2 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500">
      <option value="">-- Select Technician --</option>
    </select>

    <label class="block mb-2 text-sm font-medium">Planned Date</label>
    <input type="date" id="assignDate" class="w-full border border-gray-300 p-2 rounded-lg mb-6 focus:ring-2 focus:ring-indigo-500">

    <div class="flex justify-end gap-2">
      <button onclick="closeAssignModal()" class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">Cancel</button>
      <button onclick="submitAssign()" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white shadow-sm">Assign</button>
    </div>
  </div>
</div>

<!-- Location Modal (Leaflet / OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<div id="locationModal" class="fixed inset-0 z-[60] hidden">
  <div class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-200" id="locationModalOverlay" onclick="closeLocationModal()"></div>
  <div class="absolute inset-x-0 top-10 mx-auto w-[92%] max-w-3xl opacity-0 translate-y-4 transition-all duration-200" id="locationModalPanel">
    <div class="rounded-2xl border border-gray-200 bg-white shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-sky-50 to-indigo-50">
        <div class="flex items-center gap-2">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-600 text-white">
            <i class="fas fa-map-location-dot text-sm"></i>
          </span>
          <h3 class="text-base sm:text-lg font-semibold text-gray-900">Installation Location</h3>
        </div>
        <button class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100" onclick="closeLocationModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4">
        <div id="leafletMap" class="w-full h-[55vh] rounded-xl border border-gray-200"></div>
        <div class="mt-3 flex items-center justify-between text-xs text-gray-600">
          <span id="locCoords">‚Äî</span>
          <div class="space-x-2">
            <a id="locLinkOSM" target="_blank" class="underline text-indigo-600 hover:text-indigo-700">Open in OSM</a>
            <a id="locLinkGMaps" target="_blank" class="underline text-indigo-600 hover:text-indigo-700">Open in Google Maps</a>
          </div>
        </div>
      </div>
      <div class="px-5 py-3 border-t bg-gray-50 flex justify-end">
        <button class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-sm" onclick="closeLocationModal()">Close</button>
      </div>
    </div>
  </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
  /* modal transition helpers */
  .modal-show #locationModalOverlay { opacity: 1; }
  .modal-show #locationModalPanel   { opacity: 1; transform: translateY(0); }
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
function getCSRFToken() {
  const name = "csrftoken";
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    cookie = cookie.trim();
    if (cookie.startsWith(name + '=')) {
      return decodeURIComponent(cookie.substring(name.length + 1));
    }
  }
  return null;
}

let currentJobId = null;
let orderRefId = null;

/* ------- Status badge ------- */
function statusBadge(status) {
  const s = (status || '').toLowerCase();
  let base = "inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold ring-1 ";
  if (s === 'pending')       return `<span class="${base} bg-amber-50 text-amber-700 ring-amber-200"><i class="fas fa-hourglass-half"></i> Pending</span>`;
  if (s === 'in progress')   return `<span class="${base} bg-blue-50 text-blue-700 ring-blue-200"><i class="fas fa-spinner"></i> In&nbsp;Progress</span>`;
  if (s === 'completed')     return `<span class="${base} bg-emerald-50 text-emerald-700 ring-emerald-200"><i class="fas fa-check-circle"></i> Completed</span>`;
  return `<span class="${base} bg-gray-100 text-gray-700 ring-gray-200">${status || '‚Äî'}</span>`;
}

/* ------- Location button now opens modal ------- */
function locationButton(lat, lng) {
  if (lat == null || lng == null) {
    return `<button type="button" disabled class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-gray-200 text-gray-500 text-xs cursor-not-allowed">
              <i class="fas fa-map-pin"></i> View
            </button>`;
  }
  return `<button type="button"
            class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg bg-gradient-to-r from-sky-500 to-indigo-600 text-white text-xs shadow hover:shadow-md"
            onclick="openLocationModal(${Number(lat)}, ${Number(lng)})">
            <i class="fas fa-map-pin"></i> View
          </button>`;
}

/* ------- Leaflet Map Modal ------- */
let _leafletMap = null;
let _leafletMarker = null;

function openLocationModal(lat, lng) {
  // Show modal with transitions
  const modal = document.getElementById('locationModal');
  modal.classList.remove('hidden');
  document.body.classList.add('modal-show');

  // Update helper links / coords text
  document.getElementById('locCoords').textContent = `Lat: ${lat.toFixed(6)} | Lng: ${lng.toFixed(6)}`;
  document.getElementById('locLinkOSM').href   = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}`;
  document.getElementById('locLinkGMaps').href = `https://www.google.com/maps?q=${lat},${lng}&z=16`;

  // Initialize Leaflet once
  const mapEl = document.getElementById('leafletMap');
  if (!_leafletMap) {
    _leafletMap = L.map(mapEl, { zoomControl: true, attributionControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(_leafletMap);
  }

  // Set view + marker
  const pos = [lat, lng];
  _leafletMap.setView(pos, 16);
  if (_leafletMarker) {
    _leafletMarker.setLatLng(pos);
  } else {
    _leafletMarker = L.marker(pos).addTo(_leafletMap);
  }

  // Fix sizing after modal becomes visible
  setTimeout(() => _leafletMap.invalidateSize(), 200);
}

function closeLocationModal() {
  document.getElementById('locationModal').classList.add('hidden');
  document.body.classList.remove('modal-show');
}

// ESC to close
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLocationModal(); });

/* ------- Assign modal ------- */
function openAssignModal(jobId, orderRef) {
  currentJobId = jobId;
  document.getElementById("assignModalOrderRef").textContent = orderRef;
  orderRefId = orderRef;

  fetch(`{% url 'get_technicians' %}`)
    .then(res => res.json())
    .then(data => {
      const techSelect = document.getElementById("assignTechnicianSelect");
      techSelect.innerHTML = '<option value="">-- Select Technician --</option>';
      (data.technicians || []).forEach(tech => {
        const opt = document.createElement("option");
        opt.value = tech.id;
        opt.textContent = tech.full_name;
        techSelect.appendChild(opt);
      });
    });

  document.getElementById("assignModal").classList.remove("hidden");
}
function closeAssignModal() {
  document.getElementById("assignModal").classList.add("hidden");
  currentJobId = null;
}
async function submitAssign() {
  const technicianId = document.getElementById("assignTechnicianSelect").value;
  const plannedDate   = document.getElementById("assignDate").value;

  if (!technicianId || !plannedDate) {
    alert("Please select technician and planned date");
    return;
  }

  try {
  const res = await fetch(`{% url 'assign_to_technician' %}`, {
      method: "POST",
      headers: {"Content-Type":"application/json","X-CSRFToken": getCSRFToken()},
      body: JSON.stringify({ order_id: orderRefId, technician_id: technicianId, planned_at: plannedDate })
    });
    const data = await res.json();
    if (data.success) {
      closeAssignModal();
      refreshJobs();
    } else {
      alert(data.message || "Failed to assign technician");
    }
  } catch (err) {
    console.error(err);
    alert("Something went wrong.");
  }
}

/* ------- Data rendering ------- */
function refreshJobs() {
  const filterStatus     = document.getElementById("filterStatus").value;
  const filterTechnician = document.getElementById("filterTechnician").value;
  const search           = document.getElementById("searchInput").value;

  const params = new URLSearchParams({ status: filterStatus, technician: filterTechnician, search: search });

  fetch(`{% url 'installation_job_list' %}?${params.toString()}`)
    .then(res => res.json())
    .then(data => {
      const list            = document.getElementById("jobList");
      const pendingAssignEl = document.getElementById("pendingAssignCount");
      const pendingEl       = document.getElementById("pendingCount");
      const progressEl      = document.getElementById("progressCount");
      const completedEl     = document.getElementById("completedCount");

      list.innerHTML = "";
      let pendingAssign = 0, pending = 0, progress = 0, completed = 0;
      const technicianSet = new Set();

      (data.jobs || []).forEach((job, i) => {
        const hasTech = !!job.technician && job.technician !== 'Not Assigned';
        const stat = (job.status || '').toLowerCase();

        if (!hasTech) pendingAssign++;
        if (stat === "pending") pending++;
        else if (stat === "in progress") progress++;
        else if (stat === "completed") completed++;

        if (hasTech) technicianSet.add(job.technician);

        const actions = `
          ${!hasTech ? `
            <button onclick="openAssignModal(${job.id}, '${job.order_reference}')"
                    class="px-2 py-1.5 text-xs rounded-lg bg-purple-600 hover:bg-purple-700 text-white shadow">
              Assign
            </button>` : ``}
          ${stat === 'completed' ? `
            <button class="px-2 py-1.5 text-xs rounded-lg bg-blue-600 hover:bg-blue-700 text-white shadow">
              View Report
            </button>` : ``}
        `;

        const row = document.createElement("tr");
        row.className = "hover:bg-gray-50";
        row.innerHTML = `
          <td class="px-4 py-3">${i + 1}</td>
          <td class="px-4 py-3 font-medium text-gray-900">${job.order_reference || '‚Äî'}</td>
          <td class="px-4 py-3">${job.customer_name || '‚Äî'}</td>
          <td class="px-4 py-3">${job.customer_phone || '‚Äî'}</td>
          <td class="px-4 py-3">
            ${locationButton(job.latitude, job.longitude)}
          </td>
          <td class="px-4 py-3">${hasTech ? job.technician : '<span class="text-gray-400">Unassigned</span>'}</td>
          <td class="px-4 py-3">${job.scheduled_at || ''}</td>
          <td class="px-4 py-3">${job.started_at   || ''}</td>
          <td class="px-4 py-3">${job.completed_at || ''}</td>
          <td class="px-4 py-3">${statusBadge(job.status)}</td>
          <td class="px-4 py-3 space-x-2">${actions}</td>
        `;
        list.appendChild(row);
      });

      pendingAssignEl.textContent = pendingAssign;
      pendingEl.textContent       = pending;
      progressEl.textContent      = progress;
      completedEl.textContent     = completed;

      const techFilter = document.getElementById("filterTechnician");
      techFilter.innerHTML = '<option value="">All Technicians</option>';
      Array.from(technicianSet).sort().forEach(tech => {
        const option = document.createElement('option');
        option.value = tech;
        option.textContent = tech;
        techFilter.appendChild(option);
      });
    });
}

['filterStatus', 'filterTechnician', 'searchInput'].forEach(id => {
  document.getElementById(id).addEventListener('input', refreshJobs);
});
try { flatpickr("#assignDate", { dateFormat: "Y-m-d" }); } catch(e) {}

refreshJobs();
</script>
{% endblock %}
