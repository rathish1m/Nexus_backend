{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}

{% include 'partials/translations_cache.html' %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<section class="relative">
  <div class="pointer-events-none absolute inset-0 -z-10 blur-3xl opacity-40"
       style="background: radial-gradient(60% 50% at 20% 10%, rgba(99,102,241,.18), transparent 60%),
               radial-gradient(60% 50% at 80% 30%, rgba(236,72,153,.18), transparent 60%),
               radial-gradient(50% 40% at 50% 90%, rgba(34,197,94,.15), transparent 60%);"></div>

  <!-- KPIs (current page only) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
    <div class="relative rounded-2xl border border-blue-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-blue-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-blue-50 text-blue-600">
          <i class="fas fa-bolt"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Active Subscriptions" %}</div>
          <div id="kpiActive" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>

    <div class="relative rounded-2xl border border-emerald-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-emerald-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600">
          <i class="fas fa-wallet"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Projected Monthly Spend (Excl. Taxes)" %}</div>
          <div id="kpiSpend" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>

    <div class="relative rounded-2xl border border-amber-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-amber-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-amber-50 text-amber-600">
          <i class="fas fa-calendar-week"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Renewals (7 days)" %}</div>
          <div id="kpiUpcoming" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>

    <div class="relative rounded-2xl border border-indigo-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-indigo-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600">
          <i class="fas fa-layer-group"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Subscriptions (page)" %}</div>
          <div id="kpiTotal" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="mt-4 sm:mt-6 flex flex-col lg:flex-row lg:items-center gap-3 lg:gap-4">
    <div class="flex-1">
      <label for="subSearchInput" class="sr-only">{% trans "Search" %}</label>
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input id="subSearchInput" type="text"
               placeholder="{% trans 'Search by plan, order ref or kit number' %}"
               class="w-full pl-9 pr-3 py-2 rounded-xl border border-gray-300 bg-white/90 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" />
      </div>
    </div>

    <div class="flex gap-2">
      <label class="sr-only" for="subStatusFilter">{% trans "Status" %}</label>
      <!-- Show ALL statuses: you can add/remove as your backend uses -->
      <select id="subStatusFilter"
              class="px-3 py-2 rounded-xl border border-gray-300 bg-white/90 shadow-sm text-sm focus:ring-2 focus:ring-indigo-500">
        <option value="">{% trans "All Statuses" %}</option>
        <option value="active">{% trans "Active" %}</option>
        <option value="suspended">{% trans "Suspended" %}</option>
        <option value="inactive">{% trans "Inactive" %}</option>
        <option value="cancelled">{% trans "Cancelled" %}</option>
        <option value="pending">{% trans "Pending" %}</option>
        <option value="expired">{% trans "Expired" %}</option>
      </select>
    </div>

    <div class="flex items-center gap-2">
      <input id="subDateRange" type="text" readonly
             placeholder="{% trans 'Date range (start–end)' %}"
             class="px-3 py-2 rounded-xl border border-gray-300 bg-white/90 shadow-sm text-sm w-[14.5rem] sm:w-56 focus:ring-2 focus:ring-indigo-500" />
      <button id="subClearFilters"
              class="px-3 py-2 rounded-xl border text-sm bg-white hover:bg-gray-50">
        {% trans "Clear" %}
      </button>
    </div>
  </div>

  <!-- Desktop table -->
  <div class="mt-4 overflow-x-auto rounded-2xl border border-gray-200 bg-white/80 shadow-xl hidden md:block">
    <table class="min-w-full text-sm text-left text-gray-800">
      <thead class="sticky top-0 z-10 bg-gradient-to-r from-indigo-50 to-blue-50/80 backdrop-blur supports-[backdrop-filter]:bg-blue-50/60 text-indigo-800 text-xs font-semibold tracking-wider shadow-sm">
        <tr>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Plan" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Kit ID" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Billing Cycle" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Cycle Fee (Excl. Taxes)" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Start Date" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Next Billing" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Status" %}</th>
          <th class="px-5 py-3 whitespace-nowrap text-right">{% trans "Manage" %}</th>
        </tr>
      </thead>
      <tbody id="subscriptionTableBody" class="divide-y divide-gray-100">
        <tr>
          <td colspan="8" class="text-center px-6 py-8 text-gray-400 text-sm animate-pulse">
            {% trans "Loading subscriptions..." %}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mobile list -->
  <div id="subscriptionListMobile" class="md:hidden mt-4 space-y-3">
    <div class="rounded-xl border border-gray-200 p-4 text-gray-500 text-sm text-center animate-pulse bg-white/80">
      {% trans "Loading subscriptions..." %}
    </div>
  </div>

  <!-- Server pagination -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mt-5 px-1 text-xs sm:text-sm text-gray-500">
    <span class="flex items-center gap-1">
      <i class="fas fa-info-circle text-indigo-400"></i>
      {% trans "Showing your subscriptions" %}
    </span>
    <nav id="subscriptionPaginationContainer" class="inline-flex flex-wrap gap-1"></nav>
  </div>
</section>

<!-- ===== Details Modal ===== -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-200" onclick="closeDetailsModal()" id="detailsModalOverlay"></div>

  <div class="absolute inset-x-0 top-10 mx-auto w-[92%] max-w-4xl opacity-0 translate-y-4 transition-all duration-200" id="detailsModalPanel">
    <div class="rounded-2xl border border-gray-200 bg-white shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-indigo-50 to-blue-50">
        <div class="flex items-center gap-2">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-600 text-white">
            <i class="fas fa-file-contract text-sm"></i>
          </span>
          <div>
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">{% trans "Subscription Details" %}</h3>
            <p id="modalStatusBadge" class="text-xs mt-0.5"></p>
          </div>
        </div>
        <button class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100" onclick="closeDetailsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-5 grid grid-cols-1 lg:grid-cols-3 gap-5">
        <section class="lg:col-span-2 rounded-xl border border-gray-200 p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Plan" %}</p>
              <h4 id="mdPlanName" class="text-lg font-bold text-gray-900">—</h4>
              <p id="mdBillingCycle" class="text-sm text-gray-500">—</p>
            </div>
            <div class="text-right">
              <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Monthly Fee" %}</p>
              <p id="mdMonthlyFee" class="text-xl font-extrabold text-gray-900">$0.00</p>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 mt-4">
            <div>
              <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Order Ref" %}</p>
              <p id="mdOrderRef" class="font-semibold text-gray-800 break-all">—</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Kit Serial" %}</p>
              <p id="mdKitSerial" class="font-mono font-semibold text-indigo-700 break-all">—</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Start Date" %}</p>
              <p id="mdStartDate" class="text-gray-800">—</p>
            </div>
            <div>
              <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Next Billing" %}</p>
              <p id="mdNextBill" class="text-gray-800">—</p>
            </div>
          </div>
        </section>

        <section class="rounded-xl border border-gray-200 p-4">
          <div class="flex items-center justify-between mb-1">
            <h5 class="font-semibold text-gray-900">{% trans "Data Usage" %}</h5>
            <span id="mdUsageRange" class="text-xs text-gray-500">—</span>
          </div>
          <div class="flex justify-between text-xs text-gray-700">
            <span id="mdUsedLbl">—</span>
            <span id="mdCapLbl">—</span>
          </div>
          <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden mt-2">
            <div id="mdUsageBar" class="h-3 w-0 rounded-full transition-all duration-500"></div>
          </div>
          <p id="mdUsageNote" class="text-xs text-gray-500 mt-2">—</p>
        </section>

        <section class="lg:col-span-3 rounded-xl border border-gray-200 p-4">
          <h5 class="font-semibold text-gray-900 mb-2">{% trans "Service Location" %}</h5>
          <div id="mdMapWrap" class="rounded-lg overflow-hidden border border-gray-200 bg-gray-100 aspect-video relative">
            <div id="mdLeaflet" class="absolute inset-0"></div>
            <div class="absolute inset-0 grid place-items-center text-gray-400 text-sm" id="mdMapLoading">
              {% trans "Loading map…" %}
            </div>
          </div>
          <a id="mdMapsLink" href="#" target="_blank"
             class="mt-3 inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 text-white text-xs sm:text-sm shadow hover:shadow-md">
            <i class="fas fa-location-arrow"></i> {% trans "Open in OpenStreetMap" %}
          </a>
        </section>
      </div>

      <div class="px-5 py-4 border-t bg-gray-50 flex items-center justify-between">
        <div id="mdError" class="hidden text-sm text-rose-600"></div>
        <div class="flex items-center gap-2">
          <button id="mdTicket" type="button"
                  class="px-3 py-2 rounded-lg border border-indigo-300 bg-white hover:bg-indigo-50 text-sm inline-flex items-center gap-2">
            <i class="fas fa-life-ring"></i> {% trans "Raise Ticket" %}
          </button>
          <button id="mdSuspend" type="button"
                  class="hidden px-3 py-2 rounded-lg border border-amber-300 bg-white hover:bg-amber-50 text-sm inline-flex items-center gap-2">
            <i class="fas fa-pause-circle"></i> {% trans "Pause" %}
          </button>
          <button id="mdResume" type="button"
                  class="hidden px-3 py-2 rounded-lg border border-emerald-300 bg-white hover:bg-emerald-50 text-sm inline-flex items-center gap-2">
            <i class="fas fa-play-circle"></i> {% trans "Resume" %}
          </button>
          <button id="mdCancel" type="button"
                  class="hidden px-3 py-2 rounded-lg border border-rose-300 bg-white hover:bg-rose-50 text-sm inline-flex items-center gap-2 text-rose-700">
            <i class="fas fa-ban"></i> {% trans "Cancel" %}
          </button>
          <button class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-sm" onclick="closeDetailsModal()">
            {% trans "Close" %}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Ticket Modal ===== -->
<div id="ticketModal" class="fixed inset-0 z-[60] hidden">
  <div id="ticketModalOverlay"
       class="absolute inset-0 bg-black/70 opacity-0 transition-opacity duration-200"
       onclick="closeTicketModal()"></div>

  <div id="ticketModalPanel"
       class="absolute inset-x-0 top-16 mx-auto w-[92%] max-w-2xl opacity-0 translate-y-4 transition-all duration-200">
    <form id="ticketForm"
          class="rounded-2xl border border-gray-200 bg-white shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b bg-gradient-to-r from-indigo-50 to-blue-50">
        <div class="flex items-center gap-2">
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-600 text-white">
            <i class="fas fa-life-ring text-sm"></i>
          </span>
          <div>
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">{% trans "Create Support Ticket" %}</h3>
            <p class="text-xs text-gray-500">{% trans "Tell us what's going on and we'll help." %}</p>
          </div>
        </div>
        <button type="button"
                class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100"
                onclick="closeTicketModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="p-5 space-y-4">
        <div id="tkError" class="hidden text-sm text-rose-600"></div>

        <div>
          <label for="tkSubject" class="block text-xs font-medium text-gray-600">{% trans "Subject" %}</label>
          <input id="tkSubject" name="subject" type="text"
                 class="mt-1 w-full rounded-lg border border-gray-300 bg-white/90 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                 placeholder="{% trans 'Short title for your issue' %}" required />
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="tkCategory" class="block text-xs font-medium text-gray-600">{% trans "Category" %}</label>
            <select id="tkCategory" name="category"
                    class="mt-1 w-full rounded-lg border border-gray-300 bg-white/90 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              <option value="technical">{% trans "Technical" %}</option>
              <option value="billing">{% trans "Billing" %}</option>
              <option value="account">{% trans "Account" %}</option>
              <option value="other">{% trans "Other" %}</option>
            </select>
          </div>
          <div>
            <label for="tkPriority" class="block text-xs font-medium text-gray-600">{% trans "Priority" %}</label>
            <select id="tkPriority" name="priority"
                    class="mt-1 w-full rounded-lg border border-gray-300 bg-white/90 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
              <option value="low">{% trans "Low" %}</option>
              <option value="normal" selected>{% trans "Normal" %}</option>
              <option value="high">{% trans "High" %}</option>
            </select>
          </div>
        </div>

        <div>
          <label for="tkMessage" class="block text-xs font-medium text-gray-600">{% trans "Message" %}</label>
          <textarea id="tkMessage" name="message" rows="6"
                    class="mt-1 w-full rounded-lg border border-gray-300 bg-white/90 px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="{% trans 'Describe the issue (symptoms, when it started, screenshots if any)…' %}"></textarea>
          <p class="mt-1 text-[11px] text-gray-500" id="tkHint"></p>
        </div>
      </div>

      <div class="px-5 py-4 border-t bg-gray-50 flex items-center justify-between">
        <div class="text-xs text-gray-500">
          <span id="tkContext" class="font-medium text-gray-700"></span>
        </div>
        <div class="flex items-center gap-2">
          <button type="button"
                  class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-sm"
                  onclick="closeTicketModal()">
            {% trans "Cancel" %}
          </button>
          <button id="tkSubmit" type="submit"
                  class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm shadow">
            <i class="fas fa-paper-plane"></i> {% trans "Submit Ticket" %}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  .modal-show #detailsModalOverlay { opacity: 1; }
  .modal-show #detailsModalPanel { opacity: 1; transform: translateY(0); }

  .modal-show-ticket #ticketModalOverlay { opacity: 1; }
  .modal-show-ticket #ticketModalPanel { opacity: 1; transform: translateY(0); }
</style>

<script>
const subscriptionTranslations = {
  pauseSubscription: "{{ _('Pause this subscription?')|escapejs }}",
  resumeSubscription: "{{ _('Resume this subscription?')|escapejs }}",
  cancelSubscription: "{{ _('This is permanent. Cancel subscription?')|escapejs }}"
};

/* ---------- Helpers ---------- */
const fmtMoney = v => (v == null ? "—" : `$${Number(v).toFixed(2)}`);
function translateBillingCycle(cycle) { return translateBilling(cycle); }
function formatDate(s) {
  if (!s) return "—";
  const d = new Date(s);
  return isNaN(d) ? s : d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: '2-digit' });
}

/* Status badge */
function statusBadgeRaw(statusRaw) {
  const st = (statusRaw || "").toLowerCase();
  let cls = "bg-gray-100 text-gray-700", icon = "fa-info-circle";
  if (st === "active")    { cls = "bg-emerald-100 text-emerald-700"; icon = "fa-check-circle"; }
  if (st === "inactive")  { cls = "bg-gray-200 text-gray-800";      icon = "fa-circle"; }
  if (st === "suspended") { cls = "bg-amber-100 text-amber-700";     icon = "fa-pause-circle"; }
  if (st === "cancelled") { cls = "bg-rose-100 text-rose-700";       icon = "fa-ban"; }
  if (st === "pending")   { cls = "bg-blue-100 text-blue-700";       icon = "fa-hourglass-half"; }
  if (st === "expired")   { cls = "bg-slate-100 text-slate-700";     icon = "fa-calendar-times"; }
  const label = translateStatus(st);
  return `<span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-semibold ${cls}">
            <i class="fas ${icon}"></i> ${label}
          </span>`;
}

function setModalStatusBadge(el, status) {
  el.innerHTML = statusBadgeRaw(status);
}

/* ---------- State ---------- */
let pageItems = [];
let pagination = { current_page: 1, total_pages: 1, total_items: 0, per_page: 10 };
let dateRange = { start: null, end: null };

/* Details URL + actions */
const DETAILS_FETCH_URL = "{% url 'subscriptions_details_fetch' %}";
const API = {
  pause:  "{% url 'subscriptions_pause' %}",
  resume: "{% url 'subscriptions_resume' %}",
  cancel: "{% url 'subscriptions_cancel' %}",
  ticket: "{% url 'tickets_quick_create' %}",
};

function getCSRFToken() {
  const name = 'csrftoken=';
  const cookies = document.cookie ? document.cookie.split(';') : [];
  for (let c of cookies) { c = c.trim(); if (c.startsWith(name)) return decodeURIComponent(c.substring(name.length)); }
  return '';
}

/* KPIs */
function computeKPIs(items){
  const now = new Date();
  const in7  = new Date(now.getTime() + 7*24*60*60*1000);
  let total = items.length;
  let active = 0, spend = 0, upcoming = 0;

  items.forEach(s => {
    const st = (s.status || "").toLowerCase();
    if (st === "active") {
      active++;
      spend += Number(s.monthly_fee || s.monthly_fee_usd || s.cycle_fee || 0);
      const n = s.next_billing_date ? new Date(s.next_billing_date) : null;
      if (n && n >= now && n <= in7) upcoming++;
    }
  });
  return { total, active, spend, upcoming };
}
function renderKPIs(items){
  const { total, active, spend, upcoming } = computeKPIs(items);
  document.getElementById("kpiTotal").textContent    = total;
  document.getElementById("kpiActive").textContent   = active;
  document.getElementById("kpiSpend").textContent    = fmtMoney(spend);
  document.getElementById("kpiUpcoming").textContent = upcoming;
}

/* Filters */
function passesFiltersOnPage(s, q, statusVal, range) {
  // Search
  const text = `${s.plan_name||""} ${s.order_reference||""} ${(s.kit_number || "")} ${(s.kit_serial || "")}`.toLowerCase();
  if (q && !text.includes(q)) return false;

  // Status dropdown
  const st = (s.status || "").toLowerCase();
  if (statusVal && st !== statusVal.toLowerCase()) return false;

  // Date range by start date
  if (range.start && range.end) {
    const sd = s.started_at ? new Date(s.started_at) : (s.start_date ? new Date(s.start_date) : null);
    if (!sd || sd < range.start || sd > range.end) return false;
  }
  return true;
}

/* Manage button: allow for Active/Suspended/Inactive, disable for Cancelled */
function buildManageAction(sub) {
  const status = (sub.status || "").toLowerCase();
  const btn = (label, disabled=false, icon=disabled?'fa-eye-slash':'fa-eye') => `
    <button type="button"
            ${disabled ? 'disabled' : ''}
            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl ${disabled?'bg-gray-200 text-gray-500 cursor-not-allowed':'bg-gradient-to-r from-indigo-500 to-indigo-700 text-white hover:scale-[1.03]'} font-semibold text-xs shadow transition"
            onclick="${disabled ? '' : `openDetailsModal(${JSON.stringify(sub.id)})`}">
      <i class="fas ${icon}"></i> ${label}
    </button>`;
  if (['cancelled'].includes(status)) return btn(translateAction('manage'), true);
  return btn(translateAction('manage'));
}

/* Mobile card */
function renderMobileCard(sub){
  const action = buildManageAction(sub);
  return `
  <article class="rounded-2xl border border-gray-200 bg-white/90 p-4 shadow-sm">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-sm font-semibold text-gray-900 truncate">${sub.plan_name ?? "—"}</div>
        ${sub.order_reference ? `<div class="text-[11px] text-gray-500 break-all mt-1">{% trans "Order Ref" %}: ${sub.order_reference}</div>` : ""}
      </div>
      <div class="text-right">
        <div class="text-sm font-semibold">${fmtMoney(sub.cycle_fee)}</div>
        <div class="mt-1">${statusBadgeRaw(sub.status)}</div>
      </div>
    </div>

    <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-gray-600">
      <div class="text-gray-500">${translateLabel('billing')}</div><div class="capitalize">${translateBillingCycle(sub.billing_cycle)}</div>
      <div class="text-gray-500">${translateLabel('start')}</div><div>${formatDate(sub.started_at || sub.start_date)}</div>
      <div class="text-gray-500">${translateLabel('next_bill')}</div><div>${formatDate(sub.next_billing_date)}</div>
      <div class="text-gray-500">{% trans "Kit ID" %}</div><div>${sub.kit_serial ?? "—"}</div>
    </div>

    <div class="mt-3">${action}</div>
  </article>`;
}

/* Render table + list */
function renderSubscriptions() {
  const tbody = document.getElementById("subscriptionTableBody");
  const mobileList = document.getElementById("subscriptionListMobile");
  tbody.innerHTML = "";
  mobileList.innerHTML = "";

  const q = (document.getElementById("subSearchInput").value || "").trim().toLowerCase();
  const statusVal = document.getElementById("subStatusFilter").value || "";

  const filtered = pageItems.filter(s => passesFiltersOnPage(s, q, statusVal, dateRange));
  renderKPIs(filtered);

  if (!filtered.length) {
    tbody.innerHTML = `
      <tr><td colspan="8" class="text-center text-gray-500 py-8">${translateUI('no_match_filters')}</td></tr>`;
    mobileList.innerHTML = `
      <div class="rounded-xl border border-gray-200 p-4 text-gray-500 text-sm text-center bg-white/80">
        ${translateUI('no_match_filters')}
      </div>`;
  } else {
    filtered.forEach(sub => {
      const action = buildManageAction(sub);
      const row = `
        <tr class="text-gray-700">
          <td class="px-5 py-3">
            <div class="flex items-center gap-2">
              <span class="inline-flex h-2.5 w-2.5 rounded-full bg-indigo-400"></span>
              <span class="font-medium">${sub.plan_name ?? "—"}</span>
            </div>
          </td>
          <td class="px-5 py-3">${sub.kit_serial ?? "—"}</td>
          <td class="px-5 py-3 capitalize">${translateBillingCycle(sub.billing_cycle)}</td>
          <td class="px-5 py-3 font-medium">${fmtMoney(sub.cycle_fee)}</td>
          <td class="px-5 py-3">${formatDate(sub.started_at || sub.start_date)}</td>
          <td class="px-5 py-3">${formatDate(sub.next_billing_date)}</td>
          <td class="px-5 py-3">${statusBadgeRaw(sub.status)}</td>
          <td class="px-5 py-3 text-right">${action}</td>
        </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
      mobileList.insertAdjacentHTML("beforeend", renderMobileCard(sub));
    });
  }

  renderServerPaginationControls();
}

/* Pagination */
function renderServerPaginationControls() {
  const container = document.getElementById("subscriptionPaginationContainer");
  container.innerHTML = "";
  const totalPages = pagination.total_pages;
  const page = pagination.current_page;
  if (totalPages <= 1) return;

  const mk = (p, label = p, active = p === page, disabled = false) => {
    const el = document.createElement("button");
    el.textContent = label;
    el.className = `px-3 py-1 rounded-full text-sm font-semibold transition
      ${active ? "bg-indigo-600 text-white" : "bg-indigo-100 text-indigo-800 hover:bg-indigo-200"}
      ${disabled ? "opacity-50 cursor-not-allowed" : ""}`;
    if (!disabled) el.onclick = () => fetchSubscriptions(p);
    return el;
  };

  container.appendChild(mk(page - 1, "‹", false, !pagination.has_previous));
  const win = 5;
  let start = Math.max(1, page - Math.floor(win/2));
  let end = Math.min(totalPages, start + win - 1);
  if (end - start < win - 1) start = Math.max(1, end - win + 1);
  for (let i = start; i <= end; i++) container.appendChild(mk(i));
  container.appendChild(mk(page + 1, "›", false, !pagination.has_next));
}

/* Fetch */
async function fetchSubscriptions(page = 1, perPage = pagination.per_page || 10) {
  try {
    const url = new URL("{% url 'get_user_subscriptions' %}", window.location.origin);
    url.searchParams.set("page", page);
    url.searchParams.set("per_page", perPage);

    const res = await fetch(url, { headers: {"X-Requested-With": "XMLHttpRequest"} });
    const data = await res.json();
    if (!data || data.success === false) throw new Error("Bad response");

    pageItems = Array.isArray(data.subscriptions) ? data.subscriptions : [];
    pagination = data.pagination || { current_page: page, total_pages: 1, total_items: pageItems.length, per_page: perPage };

    renderSubscriptions();
  } catch (e) {
    console.error("Failed to load subscriptions:", e);
    const errorMsg = translateUI('failed_load');
    document.getElementById("subscriptionTableBody").innerHTML = `
      <tr><td colspan="8" class="text-center text-red-500 py-8">${errorMsg}</td></tr>`;
    document.getElementById("subscriptionListMobile").innerHTML = `
      <div class="rounded-xl border border-red-200 bg-red-50 p-4 text-red-600 text-sm text-center">
        ${errorMsg}
      </div>`;
    renderKPIs([]);
  }
}

/* Modal helpers + actions */
let currentSubscriptionId = null;
let currentSubscription = null;

function openDetailsModal(subscriptionId) {
  currentSubscriptionId = subscriptionId;
  const modal = document.getElementById('detailsModal');
  modal.classList.remove('hidden');
  document.body.classList.add('modal-show');

  document.getElementById('mdPlanName').textContent = '{% trans "Loading…" %}';
  document.getElementById('mdMonthlyFee').textContent = '—';
  document.getElementById('mdBillingCycle').textContent = '—';
  document.getElementById('mdOrderRef').textContent = '—';
  document.getElementById('mdKitSerial').textContent = '—';
  document.getElementById('mdStartDate').textContent = '—';
  document.getElementById('mdNextBill').textContent = '—';
  document.getElementById('mdUsageRange').textContent = '—';
  document.getElementById('mdUsedLbl').textContent = '—';
  document.getElementById('mdCapLbl').textContent  = '—';
  document.getElementById('mdUsageBar').style.width = '0%';
  document.getElementById('mdUsageBar').style.background = '#d1d5db';
  document.getElementById('mdUsageNote').textContent = '—';
  document.getElementById('mdMapLoading')?.classList.remove('hidden');
  document.getElementById('mdLeaflet').innerHTML = '';

  fetchSubscriptionDetails(subscriptionId);
}
function closeDetailsModal() {
  document.getElementById('detailsModal').classList.add('hidden');
  document.body.classList.remove('modal-show');
}
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeTicketModal(); closeDetailsModal(); }
});

function getDeep(obj, path) {
  if (!obj || !path) return undefined;
  return path.split('.').reduce((o, k) => (o && o[k] != null ? o[k] : undefined), obj);
}
function pickInstallCoords(s) {
  const candidates = [
    ['order_install_lat', 'order_install_lng'],
    ['order_installation_lat', 'order_installation_lng'],
    ['order_latitude', 'order_longitude'],
    ['installation_latitude', 'installation_longitude'],
    ['order.install_lat', 'order.install_lng'],
    ['order.installation_lat', 'order.installation_lng'],
    ['order.latitude', 'order.longitude'],
    ['lat', 'lng'],
    ['latitude', 'longitude'],
  ];
  for (const [la, lo] of candidates) {
    const lat = getDeep(s, la); const lng = getDeep(s, lo);
    if (isFinite(Number(lat)) && isFinite(Number(lng))) return { lat: Number(lat), lng: Number(lng) };
  }
  return null;
}
let mdMap = null, mdMarker = null;
function renderLeaflet(lat, lng) {
  if (!mdMap) {
    mdMap = L.map('mdLeaflet');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(mdMap);
  }
  if (mdMarker) { mdMap.removeLayer(mdMarker); mdMarker = null; }
  mdMap.setView([lat, lng], 15);
  mdMarker = L.marker([lat, lng]).addTo(mdMap);
  setTimeout(() => { mdMap.invalidateSize(); }, 200);
}
function setOsmLink(lat, lng) {
  const a = document.getElementById('mdMapsLink');
  if (lat && lng) {
    a.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=16/${lat}/${lng}`;
    a.classList.remove('pointer-events-none','opacity-60');
  } else {
    a.removeAttribute('href'); a.classList.add('pointer-events-none','opacity-60');
  }
}

function wireActionButtons(s) {
  const suspendBtn = document.getElementById('mdSuspend');
  const resumeBtn  = document.getElementById('mdResume');
  const cancelBtn  = document.getElementById('mdCancel');
  const ticketBtn  = document.getElementById('mdTicket');
  [suspendBtn, resumeBtn, cancelBtn, ticketBtn].forEach(b => { if (b) { b.dataset.sid = s.id; b.disabled = false; } });
  const st = (s.status || '').toLowerCase();
  suspendBtn.classList.add('hidden'); resumeBtn.classList.add('hidden'); cancelBtn.classList.add('hidden');
  if (st === 'active')   { suspendBtn.classList.remove('hidden'); cancelBtn.classList.remove('hidden'); }
  if (st === 'suspended'){ resumeBtn.classList.remove('hidden');  cancelBtn.classList.remove('hidden'); }
}

async function postJSON(url, payload) {
  const res = await fetch(url, {
    method: 'POST',
    headers: {'X-Requested-With':'XMLHttpRequest','Content-Type':'application/json','X-CSRFToken': getCSRFToken(),},
    body: JSON.stringify(payload || {}),
  });
  let json=null; try { json = await res.json(); } catch {}
  if (!res.ok || !json || json.success === false) throw new Error((json && (json.error || json.message)) || `HTTP ${res.status}`);
  return json;
}
async function doSubscriptionAction(action, sid) {
  const err = document.getElementById('mdError'); err.classList.add('hidden'); err.textContent = '';
  const map = { pause: API.pause, resume: API.resume, cancel: API.cancel };
  const url = map[action];
  if (!url) return;
  if (action === 'pause'  && !confirm(subscriptionTranslations.pauseSubscription)) return;
  if (action === 'resume' && !confirm(subscriptionTranslations.resumeSubscription)) return;
  if (action === 'cancel' && !confirm(subscriptionTranslations.cancelSubscription)) return;
  try {
    await postJSON(url, { subscription_id: sid });
    await fetchSubscriptionDetails(sid);
    await fetchSubscriptions(pagination.current_page || 1);
  } catch (e) {
    err.textContent = e.message || "{% trans 'Action failed.' %}";
    err.classList.remove('hidden');
  }
}

/* Ticket modal */
const T_ISSUE_WITH_SUB="{% trans 'Issue with subscription' %}", T_SUBSCRIPTION="{% trans 'Subscription' %}",
      T_ATTACH_HINT="{% trans 'We will attach subscription context to the ticket.' %}",
      T_MISSING_CONTEXT="{% trans 'Missing subscription context.' %}",
      T_ENTER_SUBJECT="{% trans 'Please enter a subject.' %}",
      T_SUBMITTING="{% trans 'Submitting…' %}",
      T_TICKET_CREATED="{% trans 'Ticket created successfully.' %}",
      T_COULD_NOT_CREATE_TICKET="{% trans 'Could not create ticket.' %}";

function openTicketModal() {
  const modal = document.getElementById('ticketModal');
  const sid  = (currentSubscription && currentSubscription.id) || currentSubscriptionId || '';
  const plan = (currentSubscription && currentSubscription.plan_name) || '—';
  document.getElementById('tkSubject').value = `${T_ISSUE_WITH_SUB} #${sid} – ${plan}`;
  document.getElementById('tkCategory').value = 'technical';
  document.getElementById('tkPriority').value = 'normal';
  document.getElementById('tkMessage').value = '';
  document.getElementById('tkError').classList.add('hidden');
  document.getElementById('tkError').textContent = '';
  document.getElementById('tkContext').textContent = `${T_SUBSCRIPTION} #${sid} • ${plan}`;
  document.getElementById('tkHint').textContent = T_ATTACH_HINT;
  modal.classList.remove('hidden'); document.body.classList.add('modal-show-ticket');
  requestAnimationFrame(() => {
    document.getElementById('ticketModalOverlay').style.opacity = '1';
    document.getElementById('ticketModalPanel').style.opacity = '1';
    document.getElementById('ticketModalPanel').style.transform = 'translateY(0)';
  });
}
function closeTicketModal() {
  document.getElementById('ticketModal').classList.add('hidden');
  document.body.classList.remove('modal-show-ticket');
}
document.getElementById('ticketForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const err = document.getElementById('tkError'); err.classList.add('hidden'); err.textContent = '';
  const sid = (currentSubscription && currentSubscription.id) || currentSubscriptionId;
  if (!sid) { err.textContent = T_MISSING_CONTEXT; err.classList.remove('hidden'); return; }
  const payload = {
    subscription_id: sid,
    subject:  document.getElementById('tkSubject').value?.trim(),
    category: document.getElementById('tkCategory').value,
    priority: document.getElementById('tkPriority').value,
    message:  document.getElementById('tkMessage').value?.trim(),
  };
  if (!payload.subject) { err.textContent = T_ENTER_SUBJECT; err.classList.remove('hidden'); return; }
  const submitBtn = document.getElementById('tkSubmit');
  submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + T_SUBMITTING;
  try {
    const json = await postJSON(API.ticket, payload);
    if (json.ticket_url) { window.location.href = json.ticket_url; return; }
    alert(T_TICKET_CREATED); closeTicketModal();
  } catch (e2) {
    err.textContent = e2.message || T_COULD_NOT_CREATE_TICKET; err.classList.remove('hidden');
  } finally {
    submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ' + "{% trans 'Submit Ticket' %}";
  }
});

/* Details fetch */
async function fetchSubscriptionDetails(subscriptionId) {
  try {
    const url = new URL(DETAILS_FETCH_URL, window.location.origin);
    url.searchParams.set('subscription_id', subscriptionId);
    const res  = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    const json = await res.json();
    if (!res.ok || !json.success) throw new Error(json.error || 'Load failed');

    const s = json.subscription || {};
    currentSubscription = s;
    setModalStatusBadge(document.getElementById('modalStatusBadge'), s.status);
    document.getElementById('mdPlanName').textContent     = s.plan_name || '—';
    document.getElementById('mdBillingCycle').textContent = translateBillingCycle(s.billing_cycle).toUpperCase();
    document.getElementById('mdMonthlyFee').textContent   = (s.monthly_fee_usd == null) ? '—' : `$${Number(s.monthly_fee_usd).toFixed(2)}`;
    document.getElementById('mdOrderRef').textContent     = s.order_id || s.order_reference || '—';
    document.getElementById('mdKitSerial').textContent    = s.kit_serial || '—';
    document.getElementById('mdStartDate').textContent    = formatDate(s.start_date || s.started_at);
    document.getElementById('mdNextBill').textContent     = formatDate(s.next_billing_date);
    wireActionButtons(s);

    const used = Number(s.usage_used_gb || 0);
    const cap  = Number((s.usage_cap_gb != null ? s.usage_cap_gb : s.data_cap_gb) || 0);
    const pct  = cap ? Math.min(100, Math.round((used / cap) * 100)) : 0;
    document.getElementById('mdUsedLbl').textContent = `{% trans "Used" %}: ${cap ? used.toFixed(1) : '—'} ${cap ? 'GB' : ''}`;
    document.getElementById('mdCapLbl').textContent  = `{% trans "Cap" %}: ${cap ? cap.toFixed(0) : '—'} ${cap ? 'GB' : ''}`;
    document.getElementById('mdUsageBar').style.width = cap ? pct + '%' : '0%';
    document.getElementById('mdUsageBar').style.background = !cap ? '#d1d5db' : (pct < 80 ? '#10b981' : (pct <= 100 ? '#f59e0b' : '#ef4444'));
    document.getElementById('mdUsageNote').textContent = !cap
      ? '{% trans "No cap information available." %}'
      : (pct <= 100
          ? `{% trans "You have used" %} ${pct}% {% trans "of your monthly data." %}`
          : `{% trans "You exceeded your data cap." %}`);
    const rstart = s.usage_period_start || s.period_start;
    const rend   = s.usage_period_end   || s.period_end;
    document.getElementById('mdUsageRange').textContent = (rstart || rend) ? `${formatDate(rstart)} - ${formatDate(rend)}` : '—';

    const coords = pickInstallCoords(s);
    const wrapLoader = document.getElementById('mdMapLoading');
    if (coords) {
      renderLeaflet(coords.lat, coords.lng);
      setOsmLink(coords.lat, coords.lng);
      wrapLoader?.classList.add('hidden');
    } else {
      setOsmLink(null, null);
      if (!mdMap) {
        mdMap = L.map('mdLeaflet');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mdMap);
      }
      mdMap.setView([0,0], 2);
      wrapLoader?.classList.add('hidden');
    }
    setTimeout(() => { if (mdMap) mdMap.invalidateSize(); }, 250);
  } catch (e) {
    const err = document.getElementById('mdError');
    err.textContent = "{% trans 'Could not load subscription details.' %}";
    err.classList.remove('hidden');
    console.error(e);
  }
}

/* Init */
document.addEventListener("DOMContentLoaded", () => {
  flatpickr("#subDateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    onChange: (selected) => {
      if (selected.length === 2) {
        dateRange.start = new Date(selected[0].setHours(0,0,0,0));
        dateRange.end   = new Date(selected[1].setHours(23,59,59,999));
      } else if (selected.length === 1) {
        dateRange.start = new Date(selected[0].setHours(0,0,0,0));
        dateRange.end   = null;
      } else {
        dateRange.start = dateRange.end = null;
      }
      renderSubscriptions();
    }
  });

  document.getElementById("subSearchInput").addEventListener("input", renderSubscriptions);
  document.getElementById("subStatusFilter").addEventListener("change", renderSubscriptions);
  document.getElementById("subClearFilters").addEventListener("click", () => {
    document.getElementById("subSearchInput").value = "";
    document.getElementById("subStatusFilter").value = "";
    const fp = document.getElementById("subDateRange")._flatpickr; if (fp) fp.clear();
    dateRange = { start: null, end: null };
    renderSubscriptions();
  });

  document.getElementById('mdSuspend')?.addEventListener('click', (e) => {
    const sid = e.currentTarget.dataset.sid || currentSubscriptionId; if (sid) doSubscriptionAction('pause', sid);
  });
  document.getElementById('mdResume')?.addEventListener('click', (e) => {
    const sid = e.currentTarget.dataset.sid || currentSubscriptionId; if (sid) doSubscriptionAction('resume', sid);
  });
  document.getElementById('mdCancel')?.addEventListener('click', (e) => {
    const sid = e.currentTarget.dataset.sid || currentSubscriptionId; if (sid) doSubscriptionAction('cancel', sid);
  });
  document.getElementById('mdTicket')?.addEventListener('click', () => openTicketModal());

  fetchSubscriptions(1, 10);
});
</script>
