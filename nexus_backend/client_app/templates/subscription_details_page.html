{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}

<!-- Include optimized translations cache -->
{% include 'partials/translations_cache.html' %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<section class="relative">
  <div class="pointer-events-none absolute inset-0 -z-10 blur-3xl opacity-40"
       style="background: radial-gradient(60% 50% at 20% 10%, rgba(99,102,241,.18), transparent 60%),
               radial-gradient(60% 50% at 80% 30%, rgba(236,72,153,.18), transparent 60%),
               radial-gradient(50% 40% at 50% 90%, rgba(34,197,94,.15), transparent 60%);"></div>

  <!-- KPIs (current page only) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
    <div class="relative rounded-2xl border border-blue-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-blue-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-blue-50 text-blue-600">
          <i class="fas fa-bolt"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Active Subscriptions" %}</div>
          <div id="kpiActive" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>

    <div class="relative rounded-2xl border border-emerald-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-emerald-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600">
          <i class="fas fa-wallet"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Projected Monthly Spend" %}</div>
          <div id="kpiSpend" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>

    <div class="relative rounded-2xl border border-amber-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-amber-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-amber-50 text-amber-600">
          <i class="fas fa-calendar-week"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Renewals (7 days)" %}</div>
          <div id="kpiUpcoming" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>

    <div class="relative rounded-2xl border border-indigo-200/60 bg-white shadow-md overflow-hidden">
      <div class="absolute inset-x-0 -top-24 h-40 bg-gradient-to-b from-indigo-500/15 to-transparent"></div>
      <div class="relative p-4 sm:p-5 flex items-center gap-4">
        <div class="grid place-items-center w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600">
          <i class="fas fa-layer-group"></i>
        </div>
        <div>
          <div class="text-xs uppercase tracking-wide text-gray-500">{% trans "Subscriptions (page)" %}</div>
          <div id="kpiTotal" class="text-2xl font-bold text-gray-900">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="mt-4 sm:mt-6 flex flex-col lg:flex-row lg:items-center gap-3 lg:gap-4">
    <div class="flex-1">
      <label for="subSearchInput" class="sr-only">{% trans "Search" %}</label>
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input id="subSearchInput" type="text"
               placeholder="{% trans 'Search by plan or order ref' %}"
               class="w-full pl-9 pr-3 py-2 rounded-xl border border-gray-300 bg-white/90 shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" />
      </div>
    </div>

    <div class="flex gap-2">
      <label class="sr-only" for="subStatusFilter">{% trans "Status" %}</label>
      <select id="subStatusFilter"
              class="px-3 py-2 rounded-xl border border-gray-300 bg-white/90 shadow-sm text-sm focus:ring-2 focus:ring-indigo-500">
        <option value="">{% trans "All Statuses" %}</option>
        <option value="active">active</option>
        <option value="inactive">inactive</option>
        <option value="suspended">suspended</option>
        <option value="cancelled">cancelled</option>
      </select>
    </div>

    <div class="flex items-center gap-2">
      <input id="subDateRange" type="text" readonly
             placeholder="{% trans 'Date range (start–end)' %}"
             class="px-3 py-2 rounded-xl border border-gray-300 bg-white/90 shadow-sm text-sm w-[14.5rem] sm:w-56 focus:ring-2 focus:ring-indigo-500" />
      <button id="subClearFilters"
              class="px-3 py-2 rounded-xl border text-sm bg-white hover:bg-gray-50">
        {% trans "Clear" %}
      </button>
    </div>
  </div>

  <!-- Desktop table -->
  <div class="mt-4 overflow-x-auto rounded-2xl border border-gray-200 bg-white/80 shadow-xl hidden md:block">
    <table class="min-w-full text-sm text-left text-gray-800">
      <thead class="sticky top-0 z-10 bg-gradient-to-r from-indigo-50 to-blue-50/80 backdrop-blur supports-[backdrop-filter]:bg-blue-50/60 text-indigo-800 text-xs font-semibold tracking-wider shadow-sm">
        <tr>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Plan" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Billing Cycle" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Cycle Fee" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Start Date" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Next Billing" %}</th>
          <th class="px-5 py-3 whitespace-nowrap">{% trans "Status" %}</th>
          <th class="px-5 py-3 whitespace-nowrap text-right">{% trans "Manage" %}</th>
        </tr>
      </thead>
      <tbody id="subscriptionTableBody" class="divide-y divide-gray-100">
        <tr>
          <td colspan="7" class="text-center px-6 py-8 text-gray-400 text-sm animate-pulse">
            {% trans "Loading subscriptions..." %}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Mobile list -->
  <div id="subscriptionListMobile" class="md:hidden mt-4 space-y-3">
    <div class="rounded-xl border border-gray-200 p-4 text-gray-500 text-sm text-center animate-pulse bg-white/80">
      {% trans "Loading subscriptions..." %}
    </div>
  </div>

  <!-- Server pagination -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mt-5 px-1 text-xs sm:text-sm text-gray-500">
    <span class="flex items-center gap-1">
      <i class="fas fa-info-circle text-indigo-400"></i>
      {% trans "Showing your subscriptions" %}
    </span>
    <nav id="subscriptionPaginationContainer" class="inline-flex flex-wrap gap-1"></nav>
  </div>
</section>

<!-- ===== Details MODAL (opens from Manage) ===== -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden">
  <!-- overlay -->
  <div class="absolute inset-0 bg-black/50" onclick="closeDetailsModal()"></div>

  <!-- dialog -->
  <div class="absolute inset-0 p-4 sm:p-6 flex items-start sm:items-center justify-center overflow-auto">
    <div class="w-full max-w-6xl bg-white rounded-2xl shadow-2xl border border-gray-200 relative">
      <!-- header -->
      <div class="flex items-center justify-between px-5 py-4 border-b">
        <h3 class="text-lg font-semibold">{% trans "Subscription Details" %}</h3>
        <button class="text-gray-500 hover:text-gray-700" onclick="closeDetailsModal()"><i class="fas fa-times"></i></button>
      </div>

      <!-- body (copied/adapted from your details template) -->
      <div class="px-5 sm:px-6 py-5 space-y-6">
        <!-- Row: Overview · Kit · Location -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

          <!-- Overview -->
          <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-200 p-6">
            <div class="flex items-start justify-between gap-4">
              <div>
                <p class="text-xs uppercase tracking-wider text-gray-500">{% trans "Plan" %}</p>
                <h2 id="d_planName" class="text-xl font-bold text-gray-900 mt-1">—</h2>
                <p id="d_billingCycle" class="text-sm text-gray-500">—</p>
              </div>
              <div class="text-right">
                <p class="text-xs uppercase tracking-wider text-gray-500">{% trans "Monthly Fee" %}</p>
                <p id="d_monthlyFee" class="text-2xl font-extrabold text-gray-900">$0.00</p>
                <span id="d_statusBadge" class="inline-flex items-center mt-2 px-2 py-1 rounded text-[11px]">—</span>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-6">
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Order ID" %}</p>
                <p id="d_orderId" class="font-semibold text-gray-800">—</p>
              </div>
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "KIT Serial" %}</p>
                <p id="d_kitSerial" class="font-mono font-semibold text-indigo-700">—</p>
              </div>
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Start Date" %}</p>
                <p id="d_startDate" class="text-gray-800">—</p>
              </div>
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "End Date" %}</p>
                <p id="d_endDate" class="text-gray-800">—</p>
              </div>
            </div>
          </div>

          <!-- Starlink Kit / Hardware -->
          <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-900">{% trans "Starlink Kit" %}</h3>
              <i class="fas fa-satellite-dish text-indigo-400"></i>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Kit" %}</p>
                <p id="d_kitName" class="font-semibold text-gray-900">—</p>
              </div>
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Plan Cap" %}</p>
                <p id="d_planCap" class="font-semibold text-gray-900">—</p>
              </div>
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Dish S/N" %}</p>
                <p id="d_dishSn" class="font-mono text-indigo-700">—</p>
              </div>
              <div>
                <p class="text-[11px] uppercase tracking-wider text-gray-500">{% trans "Router S/N" %}</p>
                <p id="d_routerSn" class="font-mono text-indigo-700">—</p>
              </div>
            </div>

            <div class="mt-5 flex flex-wrap gap-2">
              <a href="/{{ LANGUAGE_CODE }}{% url 'subscription_list' %}"
                 class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-800 text-sm shadow-sm">
                <i class="fas fa-arrows-rotate"></i> {% trans "Change Plan" %}
              </a>
              <button id="d_suspendBtn" type="button"
                 class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-800 text-sm shadow-sm">
                <i class="fas fa-pause-circle"></i> {% trans "Suspend" %}
              </button>
              <button id="d_resumeBtn" type="button"
                 class="hidden inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-800 text-sm shadow-sm">
                <i class="fas fa-play-circle"></i> {% trans "Resume" %}
              </button>
            </div>
          </div>

          <!-- Location -->
          <div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-semibold text-gray-900">{% trans "Service Location" %}</h3>
              <i class="fas fa-map-location-dot text-pink-400"></i>
            </div>

            <div id="d_mapWrap" class="rounded-xl overflow-hidden border border-gray-200 bg-gray-100 aspect-video">
              <div id="d_mapLoading" class="w-full h-full flex items-center justify-center text-gray-400 text-sm">
                {% trans "Loading map…" %}
              </div>
            </div>
            <a id="d_mapsLink" href="#"
               target="_blank"
               class="mt-4 inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 text-white text-sm shadow hover:shadow-md">
              <i class="fas fa-location-arrow"></i> {% trans "Open in Google Maps" %}
            </a>
          </div>
        </section>

        <!-- Data Usage -->
        <section class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold text-gray-900">{% trans "Data Usage" %}</h3>
            <span id="d_usageRange" class="text-xs text-gray-500">—</span>
          </div>
          <div class="flex justify-between text-sm text-gray-700">
            <span id="d_usedLabel">—</span>
            <span id="d_capLabel">—</span>
          </div>
          <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden mt-2">
            <div id="d_usageBar" class="h-3 w-0 rounded-full transition-all duration-500"></div>
          </div>
          <p id="d_usageNote" class="text-xs text-gray-500 mt-2">—</p>
        </section>

        <!-- Inline error -->
        <div id="d_detailError" class="hidden p-3 rounded-lg bg-red-50 border border-red-200 text-red-700 text-sm"></div>
      </div>
    </div>
  </div>
</div>

<style>
  #subscriptionTableBody tr {
    transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease;
  }
  #subscriptionTableBody tr:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 22px rgba(79,70,229,.08);
    background-image: radial-gradient(120% 120% at 0% 0%, rgba(99,102,241,.05), transparent 45%),
                      radial-gradient(120% 120% at 100% 0%, rgba(236,72,153,.05), transparent 45%);
  }
  .btn-manage { @apply inline-flex items-center gap-2 px-3 py-1.5 rounded-xl text-xs font-semibold shadow transition; }
  .modal-open { overflow: hidden; }
</style>

<script>
const subscriptionDetailsTranslations = {
  loading: "{{ _('Loading…')|escapejs }}"
};

/* ---------- Helpers ---------- */
const fmtMoney = v => (v == null ? "—" : `$${Number(v).toFixed(2)}`);
const safeDate = s => s ? new Date(s) : null;

// Fonction de traduction de cycle de facturation optimisée (utilise le cache global)
function translateBillingCycle(cycle) {
  return translateBilling(cycle);
}
function formatDate(s) {
  if (!s) return "—";
  try {
    const d = new Date(s);
    return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: '2-digit' });
  } catch { return s; }
}

/* Badge shows the RAW status text, color/icon varies by known statuses */
function statusBadgeRaw(statusRaw) {
  const st = (statusRaw || "").toLowerCase();

  // Check cache first
  const cacheKey = `${st}_badge`;
  if (window.statusBadgeCache.has(cacheKey)) {
    return window.statusBadgeCache.get(cacheKey);
  }

  let cls = "bg-gray-100 text-gray-700", icon = "fa-info-circle";
  if (st === "active")    { cls = "bg-emerald-100 text-emerald-700"; icon = "fa-check-circle"; }
  if (st === "inactive")  { cls = "bg-gray-200 text-gray-800";      icon = "fa-circle"; }
  if (st === "suspended") { cls = "bg-amber-100 text-amber-700";     icon = "fa-pause-circle"; }
  if (st === "cancelled") { cls = "bg-rose-100 text-rose-700";       icon = "fa-ban"; }

  const label = translateStatus(st) || (statusRaw ?? "—");
  const result = `<span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md text-xs font-semibold ${cls}">
            <i class="fas ${icon}"></i> ${label}
          </span>`;

  // Cache the result
  window.statusBadgeCache.set(cacheKey, result);
  return result;
}

/* ---------- State ---------- */
let pageItems = [];
let pagination = { current_page: 1, total_pages: 1, total_items: 0, per_page: 10 };
let dateRange = { start: null, end: null };

/* Details URL pattern (expects subscription ID) */
const detailsUrlTmpl = "{% url 'subscription_details' 0 %}";

/* ---------- KPIs (current page only) ---------- */
function computeKPIs(items){
  const now = new Date();
  const in7  = new Date(now.getTime() + 7*24*60*60*1000);
  let total = items.length;
  let active = 0, spend = 0, upcoming = 0;

  items.forEach(s => {
    const st = (s.status || "").toLowerCase();
    if (st === "active") {
      active++;
      spend += Number(s.monthly_fee || 0);
      const next = s.next_billing_date ? new Date(s.next_billing_date) : null;
      if (next && next >= now && next <= in7) upcoming++;
    }
  });
  return { total, active, spend, upcoming };
}
function renderKPIs(items){
  const { total, active, spend, upcoming } = computeKPIs(items);
  document.getElementById("kpiTotal").textContent    = total;
  document.getElementById("kpiActive").textContent   = active;
  document.getElementById("kpiSpend").textContent    = fmtMoney(spend);
  document.getElementById("kpiUpcoming").textContent = upcoming;
}

/* ---------- Filters (current page) ---------- */
function passesFiltersOnPage(s, q, statusVal, range) {
  const text = `${s.plan_name||""} ${s.order_reference||""}`.toLowerCase();
  if (q && !text.includes(q)) return false;
  if (statusVal && (s.status || "").toLowerCase() !== statusVal.toLowerCase()) return false;

  if (range.start && range.end) {
    const sd = safeDate(s.started_at);
    if (!sd) return false;
    if (sd < range.start || sd > range.end) return false;
  }
  return true;
}

/* ---------- Action button builder (opens modal) ---------- */
function buildManageAction(sub) {
  const st = (sub.status || "").toLowerCase();
  const detailsHref = detailsUrlTmpl.replace('0', encodeURIComponent(sub.id));

  if (st === "active") {
    // Enabled → opens modal
    return `<button type="button"
              class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-gradient-to-r from-indigo-500 to-indigo-700 text-white font-semibold text-xs shadow hover:scale-[1.03] transition"
              onclick="openDetailsModal('${sub.order_reference || ''}')">
              <i class="fas fa-gear"></i> {% trans "Manage" %}
            </button>`;
  }
  if (st === "cancelled") {
    // Disabled (visible but not clickable)
    return `<button type="button" disabled
              class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-gray-200 text-gray-500 font-semibold text-xs shadow cursor-not-allowed"
              title="{% trans 'Action unavailable for this subscription.' %}">
              <i class="fas fa-gear"></i> {% trans "Manage" %}
            </button>`;
  }
  if (st === "inactive") {
    // Hidden (no action)
    return "";
  }
  // Other statuses (e.g., suspended): hide by default
  return "";
}

/* ---------- Mobile Card ---------- */
function renderMobileCard(sub){
  const action = buildManageAction(sub);
  return `
  <article class="rounded-2xl border border-gray-200 bg-white/90 p-4 shadow-sm">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-sm font-semibold text-gray-900 truncate">${sub.plan_name ?? "—"}</div>
        ${sub.order_reference ? `<div class="text-[11px] text-gray-500 break-all mt-1">{% trans "Order Ref" %}: ${sub.order_reference}</div>` : ""}
      </div>
      <div class="text-right">
        <div class="text-sm font-semibold">${fmtMoney(sub.cycle_fee)}</div>
        <div class="mt-1">${statusBadgeRaw(sub.status)}</div>
      </div>
    </div>

    <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-gray-600">
      <div class="text-gray-500">${translateLabel('billing')}</div><div class="capitalize">${translateBillingCycle(sub.billing_cycle)}</div>
      <div class="text-gray-500">${translateLabel('start')}</div><div>${formatDate(sub.started_at)}</div>
      <div class="text-gray-500">${translateLabel('next_bill')}</div><div>${formatDate(sub.next_billing_date)}</div>
    </div>

    ${action ? `<div class="mt-3">${action}</div>` : ``}
  </article>`;
}

/* ---------- Render (current page) ---------- */
function renderSubscriptions() {
  const tbody = document.getElementById("subscriptionTableBody");
  const mobileList = document.getElementById("subscriptionListMobile");
  tbody.innerHTML = "";
  mobileList.innerHTML = "";

  const q = (document.getElementById("subSearchInput").value || "").trim().toLowerCase();
  const statusVal = document.getElementById("subStatusFilter").value || "";

  const filtered = pageItems.filter(s => passesFiltersOnPage(s, q, statusVal, dateRange));
  renderKPIs(filtered);

  if (!filtered.length) {
    tbody.innerHTML = `
      <tr><td colspan="7" class="text-center text-gray-500 py-8">${translateUI('no_match_filters')}</td></tr>`;
    mobileList.innerHTML = `
      <div class="rounded-xl border border-gray-200 p-4 text-gray-500 text-sm text-center bg-white/80">
        ${translateUI('no_match_filters')}
      </div>`;
  } else {
    filtered.forEach(sub => {
      const action = buildManageAction(sub);

      const row = `
        <tr class="text-gray-700">
          <td class="px-5 py-3">
            <div class="flex items-center gap-2">
              <span class="inline-flex h-2.5 w-2.5 rounded-full bg-indigo-400"></span>
              <span class="font-medium">${sub.plan_name ?? "—"}</span>
            </div>
          </td>
          <td class="px-5 py-3 capitalize">${translateBillingCycle(sub.billing_cycle)}</td>
          <td class="px-5 py-3 font-medium">${fmtMoney(sub.cycle_fee)}</td>
          <td class="px-5 py-3">${formatDate(sub.started_at)}</td>
          <td class="px-5 py-3">${formatDate(sub.next_billing_date)}</td>
          <td class="px-5 py-3">${statusBadgeRaw(sub.status)}</td>
          <td class="px-5 py-3 text-right">${action}</td>
        </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
      mobileList.insertAdjacentHTML("beforeend", renderMobileCard(sub));
    });
  }

  renderServerPaginationControls();
}

/* ---------- Pagination controls ---------- */
function renderServerPaginationControls() {
  const container = document.getElementById("subscriptionPaginationContainer");
  container.innerHTML = "";
  const totalPages = pagination.total_pages;
  const page = pagination.current_page;
  if (totalPages <= 1) return;

  const mk = (p, label = p, active = p === page, disabled = false) => {
    const el = document.createElement("button");
    el.textContent = label;
    el.className = `px-3 py-1 rounded-full text-sm font-semibold transition
      ${active ? "bg-indigo-600 text-white" : "bg-indigo-100 text-indigo-800 hover:bg-indigo-200"}
      ${disabled ? "opacity-50 cursor-not-allowed" : ""}`;
    if (!disabled) el.onclick = () => fetchSubscriptions(p);
    return el;
  };

  container.appendChild(mk(page - 1, "‹", false, !pagination.has_previous));
  const win = 5;
  let start = Math.max(1, page - Math.floor(win/2));
  let end = Math.min(totalPages, start + win - 1);
  if (end - start < win - 1) start = Math.max(1, end - win + 1);
  for (let i = start; i <= end; i++) container.appendChild(mk(i));
  container.appendChild(mk(page + 1, "›", false, !pagination.has_next));
}

/* ---------- Fetch (server-side) ---------- */
async function fetchSubscriptions(page = 1, perPage = pagination.per_page || 10) {
  try {
    const url = new URL("{% url 'get_user_subscriptions' %}", window.location.origin);
    url.searchParams.set("page", page);
    url.searchParams.set("per_page", perPage);

    const res = await fetch(url, { headers: {"X-Requested-With": "XMLHttpRequest"} });
    const data = await res.json();
    if (!data || data.success === false) throw new Error("Bad response");

    pageItems = Array.isArray(data.subscriptions) ? data.subscriptions : [];
    pagination = data.pagination || { current_page: page, total_pages: 1, total_items: pageItems.length, per_page: perPage };

    renderSubscriptions();
  } catch (e) {
    console.error("Failed to load subscriptions:", e);
    const errorMsg = translateUI('failed_load');
    document.getElementById("subscriptionTableBody").innerHTML = `
      <tr><td colspan="7" class="text-center text-red-500 py-8">${errorMsg}</td></tr>`;
    document.getElementById("subscriptionListMobile").innerHTML = `
      <div class="rounded-xl border border-red-200 bg-red-50 p-4 text-red-600 text-sm text-center">
        ${errorMsg}
      </div>`;
    renderKPIs([]);
  }
}

/* ======================= MODAL LOGIC + DETAILS LOADER ======================= */
function openDetailsModal(orderId) {
  // store the order id on the modal element for later
  const modal = document.getElementById('detailsModal');
  modal.dataset.orderId = orderId || '';
  modal.classList.remove('hidden');
  document.documentElement.classList.add('modal-open');

  // reset view
  primeDetailsSkeleton();
  // load
  loadSubscriptionDetailsIntoModal();
}
function closeDetailsModal() {
  const modal = document.getElementById('detailsModal');
  modal.classList.add('hidden');
  document.documentElement.classList.remove('modal-open');
}

/* ---- Details helpers (modal) ---- */
const $d = (s) => document.querySelector(s);
const d_money = (v) => (v == null || v === '') ? '—' : `$${Number(v).toFixed(2)}`;
const d_fmtDate = (s) => {
  if (!s) return '—';
  const d = new Date(s);
  if (isNaN(d)) return s;
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
};
function d_setStatusBadge(el, status) {
  const val = (status || '').toLowerCase();
  const base = "inline-flex items-center px-2 py-1 rounded text-[11px] font-semibold ring-1";
  if (val === 'active') {
    el.className = base + " bg-green-100 text-green-700 ring-green-300";
    el.textContent = translateStatus('active');
  } else if (val === 'suspended') {
    el.className = base + " bg-amber-100 text-amber-700 ring-amber-300";
    el.textContent = translateStatus('suspended');
  } else if (val === 'inactive') {
    el.className = base + " bg-gray-100 text-gray-700 ring-gray-300";
    el.textContent = translateStatus('inactive');
  } else if (val === 'cancelled') {
    el.className = base + " bg-rose-100 text-rose-700 ring-rose-300";
    el.textContent = translateStatus('cancelled');
  } else {
    el.className = base + " bg-gray-100 text-gray-700 ring-gray-300";
    el.textContent = status || '—';
  }
}
function d_paintUsage(used, cap, start, end) {
  const bar = $d('#d_usageBar'), usedLbl = $d('#d_usedLabel'), capLbl = $d('#d_capLabel'), note = $d('#d_usageNote'), range = $d('#d_usageRange');
  const u = Number(used || 0), c = Number(cap || 0);
  if (!c) {
    bar.style.width = '0%'; bar.style.background = '#d1d5db';
    usedLbl.textContent = `${translateLabel('used')}: —`;
    capLbl.textContent  = `${translateLabel('cap')}: —`;
    note.textContent    = translateUI('no_cap_info');
  } else {
    const pct = Math.min(100, Math.round((u / c) * 100));
    bar.style.width = pct + '%';
    bar.style.background = pct < 80 ? '#10b981' : (pct <= 100 ? '#f59e0b' : '#ef4444');
    usedLbl.textContent = `${translateLabel('used')}: ${u.toFixed(1)} GB`;
    capLbl.textContent  = `${translateLabel('cap')}: ${c.toFixed(0)} GB`;
    note.textContent    = pct <= 100
      ? `${t('usage', 'you_have_used')} ${pct}% ${t('usage', 'of_monthly_data')}`
      : t('usage', 'exceeded_cap');
  }
  range.textContent = (start || end) ? `${d_fmtDate(start)} - ${d_fmtDate(end)}` : '—';
}
function d_paintMap(lat, lng) {
  const wrap = $d('#d_mapWrap'), link = $d('#d_mapsLink');
  $d('#d_mapLoading')?.classList.add('hidden');
  if (!lat || !lng) {
    wrap.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-400">N/A</div>`;
    link.classList.add('pointer-events-none','opacity-60');
    return;
  }
  const src = `https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
  wrap.innerHTML = `<iframe class="w-full h-full" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${src}"></iframe>`;
  link.href = `https://www.google.com/maps?q=${lat},${lng}&z=16`;
}
function d_showError(msg) {
  const box = $d('#d_detailError');
  if (!box) return;
  box.textContent = msg;
  box.classList.remove('hidden');
}
function primeDetailsSkeleton() {
  $d('#d_planName').textContent   = subscriptionDetailsTranslations.loading;
  $d('#d_kitName').textContent    = subscriptionDetailsTranslations.loading;
  $d('#d_mapLoading')?.classList.remove('hidden');
  $d('#d_mapWrap').innerHTML = `<div id="d_mapLoading" class="w-full h-full flex items-center justify-center text-gray-400 text-sm">{% trans "Loading map…" %}</div>`;
  // clear texts
  ['#d_billingCycle','#d_monthlyFee','#d_orderId','#d_kitSerial','#d_startDate','#d_endDate','#d_planCap','#d_dishSn','#d_routerSn','#d_usedLabel','#d_capLabel','#d_usageNote','#d_usageRange']
  .forEach(sel => { const n=$d(sel); if(n){ n.textContent='—'; }});
  $d('#d_usageBar').style.width = '0%';
}

/* Fetch details into modal */
async function loadSubscriptionDetailsIntoModal() {
  try {
    const orderId = document.getElementById('detailsModal')?.dataset?.orderId || '';
    const base = `{% url 'subscriptions_details_fetch' %}`;
    const url  = orderId ? `${base}?order_id=${encodeURIComponent(orderId)}` : base;

    const res  = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    const json = await res.json();
    if (!res.ok || !json.success) throw new Error(json.error || 'Load failed');

    const s = json.subscription || {};

    // Overview
    $d('#d_planName').textContent     = s.plan_name || '—';
    $d('#d_billingCycle').textContent = translateBillingCycle(s.billing_cycle).toUpperCase();
    $d('#d_monthlyFee').textContent   = (s.monthly_fee_usd == null) ? '—' : `$${Number(s.monthly_fee_usd).toFixed(2)}`;
    $d('#d_orderId').textContent      = s.order_id || '—';
    $d('#d_kitSerial').textContent    = s.kit_serial || '—';
    $d('#d_startDate').textContent    = d_fmtDate(s.start_date);
    $d('#d_endDate').textContent      = d_fmtDate(s.end_date);
    d_setStatusBadge($d('#d_statusBadge'), s.status);

    // Hardware
    $d('#d_kitName').textContent  = s.kit_name || '—';
    $d('#d_planCap').textContent  = (s.data_cap_gb != null) ? `${Number(s.data_cap_gb).toFixed(0)} GB` : '—';
    $d('#d_dishSn').textContent   = s.dish_sn || s.kit_serial || '—';
    $d('#d_routerSn').textContent = s.router_sn || '—';

    // Map + Usage
    d_paintMap(s.lat, s.lng);

    const usageCap = (s.usage_cap_gb != null) ? s.usage_cap_gb : s.data_cap_gb;
    d_paintUsage(s.usage_used_gb, usageCap, s.usage_period_start, s.usage_period_end);

    // Actions visibility
    const status = (s.status || '').toLowerCase();
    if (status === 'active') {
      $d('#d_resumeBtn').classList.add('hidden');
      $d('#d_suspendBtn').classList.remove('hidden');
    } else if (status === 'suspended') {
      $d('#d_resumeBtn').classList.remove('hidden');
      $d('#d_suspendBtn').classList.add('hidden');
    } else {
      $d('#d_resumeBtn').classList.add('hidden');
      $d('#d_suspendBtn').classList.add('hidden');
    }
  } catch (e) {
    d_showError(translateUI('loading_details') || "Could not load subscription details.");
    console.error(e);
  }
}

/* ---------- Init + Filter hooks ---------- */
document.addEventListener("DOMContentLoaded", () => {
  flatpickr("#subDateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    onChange: (selected) => {
      if (selected.length === 2) {
        dateRange.start = new Date(selected[0].setHours(0,0,0,0));
        dateRange.end   = new Date(selected[1].setHours(23,59,59,999));
      } else if (selected.length === 1) {
        dateRange.start = new Date(selected[0].setHours(0,0,0,0));
        dateRange.end   = null;
      } else {
        dateRange.start = dateRange.end = null;
      }
      renderSubscriptions();
    }
  });

  document.getElementById("subSearchInput").addEventListener("input", renderSubscriptions);
  document.getElementById("subStatusFilter").addEventListener("change", renderSubscriptions);
  document.getElementById("subClearFilters").addEventListener("click", () => {
    document.getElementById("subSearchInput").value = "";
    document.getElementById("subStatusFilter").value = "";
    const fp = document.getElementById("subDateRange")._flatpickr;
    if (fp) fp.clear();
    dateRange = { start: null, end: null };
    renderSubscriptions();
  });

  // Esc to close modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDetailsModal();
  });

  fetchSubscriptions(1, 10);
});
</script>
