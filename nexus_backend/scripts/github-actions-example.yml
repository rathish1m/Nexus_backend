# Example GitHub Actions workflow for i18n quality assurance
# Save this as .github/workflows/i18n-qa.yml

name: ğŸŒ Internationalization Quality Assurance

on:
  push:
    branches: [main, develop, "feat/*"]
    paths:
      - "locale/**"
      - "**/*.py"
      - "**/*.html"
      - "scripts/i18n-*.sh"
  pull_request:
    branches: [main, develop]
    paths:
      - "locale/**"
      - "**/*.py"
      - "**/*.html"

jobs:
  i18n-audit:
    name: Translation Coverage Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install Django

      - name: ğŸ”§ Make scripts executable
        run: |
          chmod +x scripts/i18n-*.sh

      - name: ğŸ” Check translation coverage
        run: |
          make i18n-check

      - name: ğŸ“Š Generate detailed report
        if: always()
        run: |
          make i18n-audit-json > i18n-report.json

      - name: ğŸ“‹ Generate human-readable report
        if: always()
        run: |
          make i18n-audit > i18n-report.txt

      - name: ğŸ“¤ Upload translation reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: translation-reports
          path: |
            i18n-report.json
            i18n-report.txt
          retention-days: 7

      - name: ğŸ’¬ Comment PR with translation status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reportExists = fs.existsSync('i18n-report.txt');

            if (reportExists) {
              const report = fs.readFileSync('i18n-report.txt', 'utf8');
              const lines = report.split('\n');
              const summaryStart = lines.findIndex(line => line.includes('ğŸ“Š Summary'));

              if (summaryStart !== -1) {
                const summary = lines.slice(summaryStart, summaryStart + 10).join('\n');

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `## ğŸŒ Translation Coverage Report\n\n\`\`\`\n${summary}\n\`\`\`\n\n[View full report in artifacts](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
                });
              }
            }

  extract-strings:
    name: Extract & Validate Translation Strings
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (contains(github.ref, 'main') || contains(github.ref, 'develop'))

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install Django

      - name: ğŸ”§ Make scripts executable
        run: |
          chmod +x scripts/i18n-*.sh

      - name: ğŸ“ Extract translation strings
        run: |
          make i18n-extract

      - name: ğŸ” Check for new untranslated strings
        run: |
          git diff --exit-code locale/ || {
            echo "âš ï¸  New translatable strings detected!"
            echo "Please review and translate the following changes:"
            git diff locale/
            exit 1
          }

      - name: ğŸ’¾ Create translation update PR
        if: failure()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "i18n: Update translation strings"
          title: "ğŸŒ Update translation strings"
          body: |
            This PR contains newly extracted translation strings that need to be translated.

            ## Changes
            - New `msgid` entries extracted from code
            - Updated `.po` files

            ## Next Steps
            1. Review the new `msgid` entries
            2. Add French translations for empty `msgstr` entries
            3. Run `make i18n-compile` to test
            4. Merge when translation coverage is acceptable

            **Auto-generated by i18n workflow**
          branch: i18n/update-strings
          delete-branch: true
