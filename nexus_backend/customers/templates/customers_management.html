{% extends 'customers/customers_management_main.html' %}
{% load static i18n %}
{% get_current_language as LANGUAGE_CODE %}

{% block content %}
<!-- Page Title -->
<div class="mb-6">
  <!-- Colored Page Header -->
<header class="rounded-2xl bg-gradient-to-r from-indigo-500 via-blue-500 to-sky-400 p-6 shadow-lg text-white mb-8 animate-fade-in">
  <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight flex items-center gap-3">
    <i class="fas fa-users text-3xl opacity-90"></i>
    {% trans "Customers Management" %}
  </h1>
  <p class="mt-2 text-sm text-indigo-100">
    {% trans "Track customer status at a glance and manage accounts quickly." %}
  </p>
</header>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Total Customers -->
    <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-300 shadow-lg rounded-2xl p-6 hover:shadow-2xl hover:scale-105 transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-semibold text-blue-800">{% trans "Total Customers" %}</span>
        <i class="fas fa-user-friends text-blue-500 text-xl animate-bounce"></i>
      </div>
      <div class="text-4xl font-extrabold text-blue-900" id="totalCustomers">--</div>
    </div>

    <!-- Active Customers -->
    <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-300 shadow-lg rounded-2xl p-6 hover:shadow-2xl hover:scale-105 transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-semibold text-green-800">{% trans "Active Customers" %}</span>
        <i class="fas fa-user-check text-green-500 text-xl animate-bounce"></i>
      </div>
      <div class="text-4xl font-extrabold text-green-900" id="activeCustomers">--</div>
    </div>

    <!-- Inactive Customers -->
    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 border border-yellow-300 shadow-lg rounded-2xl p-6 hover:shadow-2xl hover:scale-105 transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-semibold text-yellow-800">{% trans "Inactive Customers" %}</span>
        <i class="fas fa-user-clock text-yellow-500 text-xl animate-bounce"></i>
      </div>
      <div class="text-4xl font-extrabold text-yellow-900" id="inactiveCustomers">--</div>
    </div>

    <!-- Suspended Customers -->
    <div class="bg-gradient-to-br from-red-50 to-red-100 border border-red-300 shadow-lg rounded-2xl p-6 hover:shadow-2xl hover:scale-105 transition">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-semibold text-red-800">{% trans "Suspended Customers" %}</span>
        <i class="fas fa-user-slash text-red-500 text-xl animate-bounce"></i>
      </div>
      <div class="text-4xl font-extrabold text-red-900" id="suspendedCustomers">--</div>
    </div>
  </div>
</div>

<!-- Customers Table Section -->
<section class="bg-white rounded-lg shadow border p-6 w-full">
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h2 class="text-2xl font-semibold text-gray-800">{% trans "All Customers" %}</h2>
    <div class="flex flex-wrap gap-3">
      <input type="text" id="searchCustomer" placeholder="{% trans 'üîç Search by name or email' %}"
        class="border border-gray-300 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
    </div>
  </div>

  <!-- Customers Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm border rounded" id="customersTable">
      <thead class="bg-gradient-to-r from-blue-100 to-blue-200 text-blue-900 uppercase text-xs">
        <tr>
          <th class="py-3 px-4 text-left">{% trans "Name" %}</th>
          <th class="py-3 px-4 text-left">{% trans "Email" %}</th>
          <th class="py-3 px-4 text-left">{% trans "Phone" %}</th>
          <th class="py-3 px-4 text-left">{% trans "Status" %}</th>
          <th class="py-3 px-4 text-left">{% trans "Registered On" %}</th>
          <th class="py-3 px-4 text-center">{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody id="customersTableBody" class="divide-y divide-gray-200 text-gray-700">
        <tr>
          <td colspan="6" class="text-center py-4 text-gray-400">{% trans "Loading customers..." %}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div id="paginationControls" class="flex justify-center mt-6 space-x-2"></div>
</section>


<!-- Customer Details Modal -->
<div id="customerDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 relative">
    <!-- Close Button -->
    <button onclick="closeCustomerDetailsModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
      <i class="fas fa-times"></i>
    </button>

    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
      <i class="fas fa-user text-blue-500"></i> Customer Details
    </h2>

    <div id="customerDetailsContent">
      <p class="text-gray-500">Loading...</p>
    </div>
  </div>
</div>

<!-- Edit Customer Modal -->
<div id="editCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <button onclick="closeEditCustomerModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
      <i class="fas fa-times"></i>
    </button>

    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
      <i class="fas fa-edit text-blue-500"></i> Edit Customer
    </h2>

    <form id="editCustomerForm">
      <input type="hidden" id="editCustomerId" name="customer_id">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Full Name</label>
        <input type="text" id="editFullName" name="full_name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Email</label>
        <input type="email" id="editEmail" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Phone</label>
        <input type="text" id="editPhone" name="phone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditCustomerModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save</button>
      </div>
    </form>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const tableBody = document.getElementById("customersTableBody");
    const paginationContainer = document.getElementById("paginationControls");
    const searchInput = document.getElementById("searchCustomer");

    // URL variables for AJAX calls
    const getCustomersUrl = "{% url 'customers:get_customers' %}";
    const getCustomerDetailsUrl = "{% url 'customers:get_customer_details' %}";
    const editCustomerUrl = "{% url 'customers:edit_customer' %}";
    const toggleStatusUrl = "{% url 'customers:toggle_customer_status' %}";
    const resetPasswordUrl = "{% url 'customers:reset_customer_password' %}";
    const deleteCustomerUrl = "{% url 'customers:delete_customer' %}";
    const purgeCustomerUrl = "{% url 'customers:purge_customer_data' %}";

    function loadCustomers(page = 1) {
        const search = searchInput.value.trim();
        const url = `${getCustomersUrl}?page=${page}&search=${encodeURIComponent(search)}`;

        fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        console.error('Response not ok:', res.status, text.substring(0, 200));
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    });
                }
                return res.json();
            })
            .then(data => {
                tableBody.innerHTML = "";
                paginationContainer.innerHTML = "";
                currentPage = page;

                if (data.success && data.customers.length > 0) {
                    // Update dashboard cards
                    document.getElementById("totalCustomers").textContent = data.total_customers;
                    document.getElementById("activeCustomers").textContent = data.active_customers;
                    document.getElementById("inactiveCustomers").textContent = data.inactive_customers;
                    document.getElementById("suspendedCustomers").textContent = data.suspended_customers;

                    // Populate table
                    data.customers.forEach(cust => {
                        let statusBadge = cust.status === "active"
                            ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">Active</span>`
                            : `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">Inactive</span>`;

                        // Action buttons (Activate/Deactivate)
                        let statusActionButton = "";
                        if (cust.status === "active") {
                            statusActionButton = `
                                <button onclick="toggleCustomerStatus(${cust.id}, 'deactivate')"
                                    class="inline-flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-xs shadow">
                                    <i class="fas fa-user-slash"></i> Deactivate
                                </button>
                            `;
                        } else {
                            statusActionButton = `
                                <button onclick="toggleCustomerStatus(${cust.id}, 'activate')"
                                    class="inline-flex items-center gap-1 bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-full text-xs shadow">
                                    <i class="fas fa-user-check"></i> Activate
                                </button>
                            `;
                        }

                        tableBody.innerHTML += `
                            <tr class="border-t hover:bg-gray-50 transition">
                                <td class="py-2 px-4 font-medium text-gray-800">${cust.name}</td>
                                <td class="py-2 px-4">${cust.email}</td>
                                <td class="py-2 px-4">${cust.phone || "‚Äî"}</td>
                                <td class="py-2 px-4">${statusBadge}</td>
                                <td class="py-2 px-4">${cust.registered_on}</td>
                                <td class="py-2 px-4 flex flex-wrap gap-1 justify-center">
                                    <button onclick="viewCustomer(${cust.id})"
                                        class="inline-flex items-center gap-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-full text-xs shadow">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button onclick="editCustomer(${cust.id})"
                                        class="inline-flex items-center gap-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-full text-xs shadow">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    ${statusActionButton}
                                    <button onclick="resetPassword(${cust.id})"
                                        class="inline-flex items-center gap-1 bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-full text-xs shadow">
                                        <i class="fas fa-key"></i> Reset Password
                                    </button>
                                    <button onclick="deleteCustomer(${cust.id})"
                                        class="inline-flex items-center gap-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-full text-xs shadow">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    <button onclick="purgeCustomerData(${cust.id})"
                                        class="inline-flex items-center gap-1 bg-black hover:bg-red-800 text-white px-3 py-1 rounded-full text-xs shadow">
                                        <i class="fas fa-skull-crossbones"></i> Purge Data
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    // Pagination
                    for (let i = 1; i <= data.total_pages; i++) {
                        const activeClass = i === currentPage
                            ? "bg-blue-600 text-white"
                            : "bg-white text-gray-700 hover:bg-blue-100";
                        paginationContainer.innerHTML += `
                            <button onclick="loadCustomers(${i})"
                                class="px-3 py-1 rounded border ${activeClass} transition">
                                ${i}
                            </button>
                        `;
                    }
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-gray-400">{% trans "No customers found." %}</td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error("Error loading customers:", error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-red-500">{% trans "Failed to load customers." %}</td>
                    </tr>
                `;
            });
    }

    // Action functions
    window.viewCustomer = id => {
        const modal = document.getElementById("customerDetailsModal");
        const content = document.getElementById("customerDetailsContent");

        modal.classList.remove("hidden");
        content.innerHTML = `<p class="text-gray-500">Loading...</p>`;

        fetch(`${getCustomerDetailsUrl}?customer_id=${id}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const cust = data.customer;
                    const kyc = data.kyc;

                    let html = `
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold">Basic Info</h3>
                            <p><strong>Name:</strong> ${cust.name}</p>
                            <p><strong>Email:</strong> ${cust.email}</p>
                            <p><strong>Phone:</strong> ${cust.phone || "‚Äî"}</p>
                            <p><strong>Status:</strong> ${cust.status}</p>
                            <p><strong>Verified:</strong> ${cust.is_verified ? "‚úÖ Yes" : "‚ùå No"}</p>
                            <p><strong>Date Joined:</strong> ${cust.date_joined}</p>
                        </div>
                    `;

                    if (kyc) {
                        html += `<div class="mt-4 border-t pt-4">
                            <h3 class="text-lg font-semibold">KYC Info (${kyc.type})</h3>
                        `;

                        if (kyc.type === "Personal") {
                            html += `
                                <p><strong>Full Name:</strong> ${kyc.full_name}</p>
                                <p><strong>Address:</strong> ${kyc.address}</p>
                                <p><strong>Document #:</strong> ${kyc.document_number}</p>
                                <p><strong>Status:</strong> ${kyc.status}</p>
                                <p><strong>Submitted At:</strong> ${kyc.submitted_at}</p>
                                ${kyc.document_file ? `<p><a href="${kyc.document_file}" target="_blank" class="text-blue-600 underline">View Document</a></p>` : ""}
                            `;
                        } else {
                            html += `
                                <p><strong>Company Name:</strong> ${kyc.company_name}</p>
                                <p><strong>Address:</strong> ${kyc.address}</p>
                                <p><strong>RCCM:</strong> ${kyc.rccm}</p>
                                <p><strong>NIF:</strong> ${kyc.nif}</p>
                                <p><strong>ID Nat:</strong> ${kyc.id_nat}</p>
                                <p><strong>Representative:</strong> ${kyc.representative_name}</p>
                                <p><strong>Status:</strong> ${kyc.status}</p>
                                <p><strong>Submitted At:</strong> ${kyc.submitted_at}</p>
                                ${kyc.rep_id_available ? `<p><strong>Representative ID:</strong> <span class="text-blue-600">${kyc.rep_id_name || 'Available'}</span></p>` : ""}

                                ${kyc.multiple_documents && kyc.multiple_documents.length > 0 ? `
                                    <div class="mt-3">
                                        <p><strong>Company Documents (${kyc.documents_count}):</strong></p>
                                        <ul class="list-disc list-inside ml-4 space-y-1">
                                            ${kyc.multiple_documents.map(doc => `
                                                <li class="text-sm">
                                                    <span class="text-blue-600">${doc.name}</span>
                                                    ${doc.filename ? `<span class="text-gray-500"> (${doc.filename})</span>` : ''}
                                                    ${doc.uploaded_at ? `<span class="text-xs text-gray-400 block ml-4">Uploaded: ${doc.uploaded_at}</span>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : (kyc.company_docs_available ? `<p><strong>Company Document:</strong> <span class="text-blue-600">${kyc.company_docs_name || 'Available'}</span></p>` : '')}
                            `;
                        }

                        html += `</div>`;
                    } else {
                        html += `<p class="mt-4 text-yellow-600">No KYC information available.</p>`;
                    }

                    content.innerHTML = html;
                } else {
                    content.innerHTML = `<p class="text-red-500">Failed to load customer details.</p>`;
                }
            })
            .catch(err => {
                console.error(err);
                content.innerHTML = `<p class="text-red-500">Error loading customer details.</p>`;
            });
    };

    window.editCustomer = id => {
        console.log("editCustomer called with id:", id);
        // Load customer data and open edit modal
        fetch(`${getCustomerDetailsUrl}?customer_id=${id}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(res => {
                console.log("editCustomer fetch response:", res.status, res.statusText);
                if (!res.ok) {
                    return res.text().then(text => {
                        console.error('Response not ok:', res.status, text.substring(0, 200));
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    });
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    const cust = data.customer;
                    document.getElementById("editCustomerId").value = cust.id;
                    document.getElementById("editFullName").value = cust.name;
                    document.getElementById("editEmail").value = cust.email;
                    document.getElementById("editPhone").value = cust.phone || "";
                    document.getElementById("editCustomerModal").classList.remove("hidden");
                } else {
                    alert("Failed to load customer data.");
                }
            })
            .catch(error => {
                console.error("Error loading customer:", error);
                alert("Failed to load customer data.");
            });
    };

    window.toggleCustomerStatus = (id, action) => {
        if (confirm(`Are you sure you want to ${action} customer #${id}?`)) {
            fetch(toggleStatusUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ customer_id: id, action: action })
            })
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadCustomers(currentPage);
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error("Error toggling status:", error);
                alert("Failed to toggle customer status.");
            });
        }
    };

    window.resetPassword = id => {
        if (confirm(`Reset password for customer #${id}? A new password will be generated and sent to the customer's email.`)) {
            fetch(resetPasswordUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ customer_id: id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Password reset successfully! An email with the new password has been sent to the customer.");
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error("Error resetting password:", error);
                alert("Failed to reset password.");
            });
        }
    };

    window.deleteCustomer = id => {
        if (confirm(`Delete customer #${id}? This will keep their data in the system.`)) {
            fetch(deleteCustomerUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ customer_id: id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadCustomers(currentPage);
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error("Error deleting customer:", error);
                alert("Failed to delete customer.");
            });
        }
    };

    window.purgeCustomerData = id => {
        const password = prompt(`‚ö†Ô∏è WARNING: This will permanently erase all data for customer #${id}. Enter admin password to confirm:`);
        if (password) {
            fetch(purgeCustomerUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({ customer_id: id, admin_password: password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    loadCustomers(currentPage);
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error("Error purging customer data:", error);
                alert("Failed to purge customer data.");
            });
        }
    };

    // Edit modal functions
    window.closeEditCustomerModal = function() {
        document.getElementById("editCustomerModal").classList.add("hidden");
    }

    document.getElementById("editCustomerForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = {
            customer_id: formData.get("customer_id"),
            full_name: formData.get("full_name"),
            email: formData.get("email"),
            phone: formData.get("phone")
        };

        fetch(editCustomerUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                "X-Requested-With": "XMLHttpRequest"
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeEditCustomerModal();
                loadCustomers(currentPage);
            } else {
                alert(`Error: ${data.error}`);
            }
        })
        .catch(error => {
            console.error("Error updating customer:", error);
            alert("Failed to update customer.");
        });
    });

    searchInput.addEventListener("keyup", () => loadCustomers(1));

    // Initial load
    loadCustomers();
});


function viewCustomer(id) {
    const modal = document.getElementById("customerDetailsModal");
    const content = document.getElementById("customerDetailsContent");

    modal.classList.remove("hidden");
    content.innerHTML = `<p class="text-gray-500">Loading...</p>`;

    fetch(`${getCustomerDetailsUrl}?customer_id=${id}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const cust = data.customer;
                const kyc = data.kyc;

                let html = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold">Basic Info</h3>
                        <p><strong>Name:</strong> ${cust.name}</p>
                        <p><strong>Email:</strong> ${cust.email}</p>
                        <p><strong>Phone:</strong> ${cust.phone || "‚Äî"}</p>
                        <p><strong>Status:</strong> ${cust.status}</p>
                        <p><strong>Verified:</strong> ${cust.is_verified ? "‚úÖ Yes" : "‚ùå No"}</p>
                        <p><strong>Date Joined:</strong> ${cust.date_joined}</p>
                    </div>
                `;

                if (kyc) {
                    html += `<div class="mt-4 border-t pt-4">
                        <h3 class="text-lg font-semibold">KYC Info (${kyc.type})</h3>
                    `;

                    if (kyc.type === "Personal") {
                        html += `
                            <p><strong>Full Name:</strong> ${kyc.full_name}</p>
                            <p><strong>Address:</strong> ${kyc.address}</p>
                            <p><strong>Document #:</strong> ${kyc.document_number}</p>
                            <p><strong>Status:</strong> ${kyc.status}</p>
                            <p><strong>Submitted At:</strong> ${kyc.submitted_at}</p>
                            ${kyc.document_file ? `<p><a href="${kyc.document_file}" target="_blank" class="text-blue-600 underline">View Document</a></p>` : ""}
                        `;
                    } else {
                        html += `
                            <p><strong>Company Name:</strong> ${kyc.company_name}</p>
                            <p><strong>Address:</strong> ${kyc.address}</p>
                            <p><strong>RCCM:</strong> ${kyc.rccm}</p>
                            <p><strong>NIF:</strong> ${kyc.nif}</p>
                            <p><strong>ID Nat:</strong> ${kyc.id_nat}</p>
                            <p><strong>Representative:</strong> ${kyc.representative_name}</p>
                            <p><strong>Status:</strong> ${kyc.status}</p>
                            <p><strong>Submitted At:</strong> ${kyc.submitted_at}</p>
                            ${kyc.rep_id_available ? `<p><strong>Representative ID:</strong> <span class="text-blue-600">${kyc.rep_id_name || 'Available'}</span></p>` : ""}

                            ${kyc.multiple_documents && kyc.multiple_documents.length > 0 ? `
                                <div class="mt-3">
                                    <p><strong>Company Documents (${kyc.documents_count}):</strong></p>
                                    <ul class="list-disc list-inside ml-4 space-y-1">
                                        ${kyc.multiple_documents.map(doc => `
                                            <li class="text-sm">
                                                <span class="text-blue-600">${doc.name}</span>
                                                ${doc.filename ? `<span class="text-gray-500"> (${doc.filename})</span>` : ''}
                                                ${doc.uploaded_at ? `<span class="text-xs text-gray-400 block ml-4">Uploaded: ${doc.uploaded_at}</span>` : ''}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : (kyc.company_docs_available ? `<p><strong>Company Document:</strong> <span class="text-blue-600">${kyc.company_docs_name || 'Available'}</span></p>` : '')}
                        `;
                    }

                    html += `</div>`;
                } else {
                    html += `<p class="mt-4 text-yellow-600">No KYC information available.</p>`;
                }

                content.innerHTML = html;
            } else {
                content.innerHTML = `<p class="text-red-500">Failed to load customer details.</p>`;
            }
        })
        .catch(err => {
            console.error(err);
            content.innerHTML = `<p class="text-red-500">Error loading customer details.</p>`;
        });
}

function closeCustomerDetailsModal() {
    document.getElementById("customerDetailsModal").classList.add("hidden");
}

</script>
{% endblock %}
